<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/bsg-univers/lecteur-bsg/refs/heads/main/media/logo-BSG.png">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/bsg-univers/lecteur-bsg/refs/heads/main/media/logo-BSG.png">

    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0b0e14">
    <title>Baleine sous gravillon ‚Äì Les podcasts</title>
    <meta name="title" content="Baleine sous gravillon ‚Äî Les podcasts du Vivant">
    <meta name="description" content="Plongez dans les profondeurs du vivant avec notre lecteur de playlists d√©di√©.">

    <meta property="og:type" content="website">
    <meta property="og:url" content="https://bsg-univers.github.io/bsg-player/">
    <meta property="og:title" content="Baleine sous gravillon ‚Äî Les podcasts du Vivant">
    <meta property="og:description" content="√âcoutez nos √©pisodes et playlists th√©matiques. Une immersion sonore unique.">
    <meta property="og:image" content="https://baleinesousgravillon.com/wp-content/uploads/2022/05/Banniere_fb_orditel_FG_8-scaled.jpg">

    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:title" content="Baleine sous gravillon ‚Äî Les podcasts">
    <meta property="twitter:description" content="Plongez dans les profondeurs du Vivant.">
    <meta property="twitter:image" content="https://baleinesousgravillon.com/wp-content/uploads/2022/05/Banniere_fb_orditel_FG_8-scaled.jpg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gloria+Hallelujah&family=Rock+Salt&display=swap" rel="stylesheet">

    <style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  text-rendering: optimizeLegibility;
}

:root{
  --primary:#d2b347;

  --black-void:#050608;
  --blue-abyss:#031b28;
  --green-abyss:#04251e;

  --glass-soft:rgba(255,255,255,0.04);
  --glass-strong:rgba(255,255,255,0.08);
}

body::before{
  content:"";
  position:fixed;
  left:-1px; /* D√©calage anti-aliasing */
  right:0;
  bottom:0;
  pointer-events:none;
  z-index:-1;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.035'/%3E%3C/svg%3E");
}

        
/* ===================== */
/*      FOND GLOBAL      */
/* ===================== */

/* √Ä ajouter dans votre CSS */
html, body {
    min-height:100%; 
}
        
html {
  scroll-behavior: smooth;
  /* Emp√™che les rebonds √©lastiques excessifs sur iOS */
  overscroll-behavior-y: auto; 
}
        
body{
  font-family:'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
  font-size:1.1rem;
  color: rgba(234, 234, 234, 0.85);
  margin:0;
  padding-bottom:160px;

  min-height:100vh;

  background-color:#0b0e14;
  background-image:
    radial-gradient(circle at 20% 30%, rgba(70,130,180,0.28) 0%, transparent 60%),
    radial-gradient(circle at 80% 70%, rgba(0,120,90,0.18) 0%, transparent 65%),
    radial-gradient(circle at 50% 50%, rgba(0,40,60,0.22) 0%, transparent 70%);

  background-repeat:no-repeat;
  background-size:cover;
  background-position:center center;
  -webkit-overflow-scrolling: touch; /* Force le scroll "inertiel" sur vieux iOS */
  overflow-x: hidden; /* √âvite les glissements lat√©raux parasites */
}

/* ===================== */
/*        HEADER         */
/* ===================== */
header {
    text-align: center;
    padding: 10px 20px 10px;
    background: transparent;
    margin-top: 0;
}

.logo-main {
    max-width: 140px;
    height: auto;
    display: block; /* √âvite les d√©calages de texte */
    transition: transform 0.3s ease;
}
/* Le dock "languette" optimis√© (A√©rien & √âconome en batterie) */
/* 1. LE DOCK (√âtat normal : collant) */
.nav-dock {
    position: sticky;
    top: 0 !important;
    z-index: 3000;
    width: fit-content;    
    
    /* Centrage robuste pour Mobile et Desktop */
    margin: 0 auto 5px auto; 
    left: 0;
    right: 0;

    display: flex;
    gap: 10px;
    padding: 0 16px 10px 16px; 
    background: #0d1117; 
    border-radius: 0 0 20px 20px; 
    border: 1px solid rgba(210, 179, 71, 0.2); 
    border-top: none; 
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
    transition: all 0.3s ease;
}

/* 2. LE DOCK STATIQUE (Correction de la superposition) */
.nav-dock.is-static {
    /* On utilise 'relative' au lieu d' 'absolute' ! */
    /* Cela permet de garder sa place dans la page et d'emp√™cher les galets de monter dessous */
    position: relative !important; 
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    transform: none !important; /* On annule le transform si vous en aviez mis un */
    
    background: #0d1117;
    border: 1px solid rgba(243, 195, 0, 0.4); 
    box-shadow: none;
    border-top: none; 
    margin-bottom: 5px;
}

/* 3. LES LIENS/IMAGES DU DOCK */
.site-image-link {
    width: 48px; 
    height: 48px;
    margin-top: 6px;
    border-radius: 5px;
    overflow: hidden;
    flex-shrink: 0;
    border: 1px solid rgba(243, 195, 0, 0.3);
    transition: transform 0.2s ease;
}

.site-image-link img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
}

/* 4. INTERACTIONS */
.site-image-link:active {
    transform: scale(0.92);
    border-color: var(--primary);
}


/* ===================== */
/*       CONTENU         */
/* ===================== */

.btn-explore-themes {
    width: 40px; /* Un peu plus grand que les boutons de partage */
    height: 40px;
    border-radius: 50%;
    background: rgba(210, 179, 71, 0.1);
    border: 1px solid var(--primary);
    color: var(--primary);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 1.2rem;
    transition: all 0.3s ease;
    flex-shrink: 0;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    margin-right: 10.5px;
    margin-top: 12px;
    transition: all .3s ease;
    animation: pulse-border 12s infinite ease-in-out;
        /* Supprime le rectangle bleu sur mobile */
    -webkit-tap-highlight-color: transparent;
      
    /* Supprime le contour de s√©lection au focus (clavier/accessibilit√©) */
    outline: none;
}

/* Conteneur pour aligner Titre + Bouton */
.season-title-container {
    display: flex;
    align-items: center;
    justify-content: space-between; /* Changez flex-start par space-between */
    margin: 0 0 18px;
    width: 100%;
    -webkit-tap-highlight-color: transparent;
      
    /* Supprime le contour de s√©lection au focus (clavier/accessibilit√©) */
    outline: none;
}
/* On ajuste le H2 pour qu'il ne prenne pas toute la place et qu'il n'ait plus sa propre marge */
.season-title-container h2 {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.search-container {
    margin: 15px 0;
}

#playlist-search {
    width: 100%;
    padding: 10px 14px;
    border-radius: 12px;
    border: 1px solid rgba(210, 179, 71, 0.2);
    background: rgba(255,255,255,0.04);
    color: white;
    font-size: 0.95rem;
    outline: none;
}

#playlist-search:focus {
    border-color: var(--primary);
}

.season-badge {
    font-size: 0.7rem;
    background: rgba(243, 195, 0, 0.2);
    color: var(--primary);
    padding: 2px 6px;
    border-radius: 4px;
    margin-left: 8px;
    text-transform: uppercase;
    border: 1px solid rgba(243, 195, 0, 0.3);
}

.playlist-info {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    flex-grow: 1;
}
        
#hashtag-cloud {
    max-height: 300px;           /* hauteur fixe discr√®te */
    overflow-y: auto; 
    display: flex;
    flex-wrap: wrap;
    gap: 10px; /* Plus d'espace entre les tags dans la biblioth√®que */
    justify-content: center; /* Centre les tags pour un look "nuage" */
    padding: 10px 0;
}

.hashtags-cloud::-webkit-scrollbar {
    width: 6px;
}

.hashtags-cloud::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,0.3);
    border-radius: 6px;
}

.hashtags-cloud::-webkit-scrollbar-track {
    background: transparent;
}

/* On s'assure que les tags r√©agissent bien au survol dans la biblioth√®que */
#hashtag-cloud .tag-mini:hover {
    background: var(--primary);
    color: #000;
    transform: scale(1.05);
    transition: all 0.2s ease;
}

/* Le conteneur global de la playlist */
.playlist-banner {
    display: flex;
    flex-direction: column; /* On empile les √©l√©ments verticalement */
    gap: 12px;
    padding: 15px;
    background: rgba(255, 255, 255, 0.04);
    border-radius: 12px;
    margin-bottom: 16px;
    cursor: pointer;
    border: 1px solid transparent;
    -webkit-tap-highlight-color: transparent;
      
    /* Supprime le contour de s√©lection au focus (clavier/accessibilit√©) */
    outline: none;
}

/* La partie haute : Image + Titre */
.playlist-top-row {
    display: flex;
    align-items: center;
    gap: 15px;
    width: 100%;
}

.playlist-thumb {
    width: 60px;
    height: 60px;
    border-radius: 8px;
    object-fit: cover;
    flex-shrink: 0;
}

.playlist-name-text {
    flex: 1;
    font-weight: bold;
    font-size: 1.05rem;
    /* On garde la s√©curit√© de coupe si vraiment c'est trop long */
    display: -webkit-box;
    color:var(--primary);
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* La partie basse : Hashtags sur toute la ligne */
.playlist-tags-area {
    display: flex;
    flex-wrap: wrap; /* Reviennent √† la ligne si trop nombreux */
    gap: 8px;
    width: 100%;
    padding-top: 5px;
    border-top: 1.5px solid rgba(210, 179, 71, 0.08); /* Petite s√©paration discr√®te */
}

.tag-mini {
    flex-shrink: 0;
    font-size: 0.75rem;
    color: #eee;
    background: rgba(210, 179, 71, 0.1);
    padding: 2px 8px;
    border-radius: 12px;
    border: 1px solid rgba(210, 179, 71, 0.3);
    cursor: pointer;
    transition: all 0.2s ease;
}
        
/* Titre sp√©cial pour la vue filtr√©e */
.filter-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(255, 255, 255, 0.05);
    padding: 10px 15px;
    border-radius: 12px;
    margin-top: 20px;
    margin-bottom: 20px;
}

.btn-close-filter {
    background: var(--primary);
    border: none;
    color: #0b0e14;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: bold;
    cursor: pointer;
}
        
.container{
  max-width:820px;
  margin:auto;
  padding:28px 20px;
}

h2,h3{
  color:var(--primary);
  font-size:1rem;
  letter-spacing:1px;
  text-transform:uppercase;
  margin:32px 0 18px;
  padding-left:14px;
  border-left:3px solid var(--primary);
  text-shadow:0 0 10px rgba(243,195,0,0.15);
}

/* ===================== */
/* SAISONS ZEN - UNIQUE  */
/* ===================== */

.grid-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(92px, 1fr));
  gap: 20px;
  perspective: 1000px;
}

@media (max-width: 640px) {
  .grid-list {
    grid-template-columns: repeat(auto-fill, minmax(75px, 1fr));
    gap: 12px;
  }
}


/* Modification du texte √† l'int√©rieur du galet */
.season-item {
    font-family: 'Gloria Hallelujah', cursive !important;
    font-size: 1.6rem; 
    font-weight: 700;
    /* --- EFFET CRAYON GRAPHITE --- */
    /* On utilise une couleur gris anthracite tr√®s fonc√© plut√¥t que noir pur */
    color: rgba(0, 0, 0, 0.8); 
    /* Ombre tr√®s fine pour simuler l'√©paisseur du trait de crayon dans le relief */
    text-shadow: 
        0.5px 0.5px 0px rgba(255,255,255,0.05), 
        -0.5px -0.5px 0px rgba(0,0,0,0.2);
    position: relative;
    padding: 8px;
    cursor: pointer;
    z-index: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 70px; /* Un peu plus grand pour le volume */
    border: none !important;
    outline: none;
    
    /* OMBRES PORT√âES RENFORC√âES (Multi-couches pour le poids) */
    box-shadow: 
        0 20px 40px rgba(0, 0, 0, 0.6),     /* Ombre port√©e principale */
        0 10px 15px rgba(0, 0, 0, 0.4),      /* Ombre de proximit√© */
        inset 0 1px 1px rgba(255, 255, 255, 0.1), 
        inset 0 -18px 30px rgba(0, 0, 0, 0.5), /* Ombre interne fond du galet */
        inset 10px 15px 35px rgba(255, 255, 255, 0.04) !important;

    will-change: transform;
    animation: float-organic infinite alternate ease-in-out;
    animation-duration: calc(4s + var(--i, 0) * 0.5s);
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    overflow: hidden;
    -webkit-tap-highlight-color: transparent;
}

/* COUCHE 2 : Les Veines de la pierre (Marbrure) */
.season-item::after {
  content: "";
  position: absolute;
  inset: 0;
  border-radius: inherit;
  /* SVG de turbulence basse fr√©quence pour les taches naturelles */
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='veins'%3E%3CfeTurbulence type='turbulence' baseFrequency='0.015' numOctaves='3'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23veins)'/%3E%3C/svg%3E");
  opacity: 0.15;
  mix-blend-mode: soft-light;
  pointer-events: none;
  z-index: -1;
}

/* TEXTURES (Grain et Marbrure) */
.season-item::before {
    content: "";
    position: absolute;
    inset: 0;
    border-radius: inherit;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 250 250' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
    opacity: 0.18; /* Texture plus brute */
    mix-blend-mode: overlay;
    z-index: -1;
}

/* VARIATIONS (Couleurs plus denses et sombres) */
.season-item:nth-child(6n+1) {
    border-radius: 65% 35% 62% 38% / 48% 62% 38% 52% !important;
    background: radial-gradient(circle at 35% 35%, #424952, #16181b) !important;
}
.season-item:nth-child(6n+2) {
    border-radius: 42% 58% 38% 62% / 58% 42% 58% 42% !important;
    background: radial-gradient(circle at 35% 35%, #d1cdc0, #8a8576) !important;
    color: #2a2a2a !important; /* Marqueur noir sur pierre claire */
}
.season-item:nth-child(6n+3) {
    border-radius: 62% 38% 68% 32% / 42% 58% 42% 58% !important;
    background: radial-gradient(circle at 35% 35%, #59514a, #2b2622) !important;
}
.season-item:nth-child(6n+4) {
    border-radius: 48% 52% 62% 38% / 62% 38% 62% 38% !important;
    background: radial-gradient(circle at 35% 35%, #424c56, #21262b) !important;
}
.season-item:nth-child(6n+5) {
    border-radius: 75% 25% 72% 28% / 38% 38% 62% 62% !important;
    background: radial-gradient(circle at 35% 35%, #353b36, #141614) !important;
}
.season-item:nth-child(6n+6) {
    border-radius: 48% 52% 48% 52% / 48% 48% 58% 42% !important;
    background: radial-gradient(circle at 35% 35%, #767b82, #3e4146) !important;
}
        
/* √âTAT ACTIF : Ombre Jaune Lumineuse */
.season-item.active {
    background: var(--primary) !important;
    color: #0b0e14 !important;
    transform: scale(0.94) translateY(5px) !important;
    animation: none !important;
    box-shadow: 
        0 15px 35px rgba(210, 179, 71, 0.4), /* Lueur jaune */
        inset 0 3px 6px rgba(255, 255, 255, 0.6),
        inset 0 -6px 12px rgba(0, 0, 0, 0.2) !important;
}

/* --- √âTAT ACTIF (Volume Lumineux) --- */
.season-item.active {
  background: var(--primary) !important;
  color: #0b0e14 !important;
  transform: scale(0.96) !important;
  animation: none !important;
  /* Ombre port√©e jaune + Ombre interne pour garder le volume m√™me en couleur */
  box-shadow: 
    0 10px 25px rgba(243, 195, 0, 0.4),
    inset 0 3px 5px rgba(255, 255, 255, 0.5),
    inset 0 -5px 10px rgba(0, 0, 0, 0.2) !important;
}

/* --- INTERACTIONS --- */
.season-item:hover {
  transform: translateY(-5px) scale(1.05);
  filter: brightness(1.15);
  z-index: 2;
}

@keyframes float-organic {
  0%   { transform: rotate(0deg) translate(0, 0); }
  50%  { transform: rotate(1.5deg) translate(2px, -3px); }
  100% { transform: rotate(-1.5deg) translate(-1px, -1px); }
}

/* ===================== */
/*      √âPISODES         */
/* ===================== */

/* L'√âTAT DE BASE (Petit) */
#player-img {
    position: fixed !important;
    left: 50% !important;
    width: 140px;
    height: 140px;
    z-index: 10000 !important;
    
    /* On pr√©pare la transformation */
    transform: translateX(-50%) translateY(0) scale(1);
    
    border-radius: 12px;
    object-fit: contain;
    background: #000;
    border: 1px solid rgba(243, 195, 0, 0.4);
    
    /* Transition sur le transform uniquement pour la performance */
    transition: transform 0.7s cubic-bezier(0.4, 0, 0.2, 1), 
                box-shadow 0.5s ease;
    cursor: zoom-in;
    pointer-events: auto !important;
}

/* √âTAT LOGO (Petit) */
#player-img.is-logo {
    width: 60px; /* Taille miniature */
    bottom: 100px;
    height: 60px;
    border-radius: 50%; /* On peut m√™me le mettre en rond */
    border: 1px solid rgba(243, 195, 0, 0.4);
    box-shadow: 0 4px 15px rgba(0,0,0,0.4);
    animation: playerSubtleWave 12s infinite ease-in-out;
    pointer-events: auto; 
    cursor: pointer;
}

/* √âTAT √âPISODE (Grand) */
#player-img.is-episode {
    bottom: 110px;
    width: 130px;
    height: 130px;
    border-radius: 12px;
    border: 1px solid rgba(243, 195, 0, 0.4);
    pointer-events: auto;
    cursor: zoom-in;
    box-shadow: 0 8px 25px rgba(0,0,0,0.6);
    animation: playerSubtleWave 12s infinite ease-in-out;
}
        
/* D√©sactive le lien compl√®tement d√®s que l'image n'est plus un logo */
#logo-link:has(.is-episode), 
#logo-link:has(.zoomed) {
    pointer-events: none; /* Le clic traverse le lien sans l'activer */
    cursor: default;
}

/* L'√âTAT ZOOM√â (Grand et visible en entier) */
#player-img.zoomed {
    z-index: 8500 !important; 
    
    /* Au lieu de changer 'top', on pousse l'image vers le haut avec translateY */
    /* -45vh fait monter l'image d'environ la moiti√© de l'√©cran */
    transform: translateX(-50%) translateY(-35vh) scale(2.2) !important;
    
    border-radius: 15px;
    border: 0.5px solid rgba(243, 195, 0, 0.4);
    cursor: zoom-out;
    
    /* Fond noir progressif (L√©ger & √âconome) */
    box-shadow: 0 0 0 200vmax rgba(5, 6, 8, 0.9) !important;
}

    /* Par d√©faut, le lien fonctionne */
#logo-link {
    text-decoration: none;
    cursor: default;
}


/* Ajustement sp√©cifique pour les petits √©crans mobiles */
@media (max-height: 700px) {
    #player-img.zoomed {
        transform: translateX(-50%) translateY(-20vh) scale(2) !important;
    }
}


/* D√©sactiver l'animation de vague pendant le zoom pour √©viter les tremblements */
#player-img.zoomed {
    animation: none !important;
}
    

/* Animation d'ouverture */
@keyframes zoomIn {
    from { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
    to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
}
        
/* Conteneur sp√©cial pour le titre H2 et son bouton de partage */
.playlist-header-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin: 32px 0 18px;
    padding-left: 14px;
    border-left: 3px solid var(--primary);
    scroll-margin-top: 15px;
    -webkit-tap-highlight-color: transparent;
      
    /* Supprime le contour de s√©lection au focus (clavier/accessibilit√©) */
    outline: none;
}

/* On r√©initialise les marges du H2 car le conteneur g√®re l'espacement maintenant */
.playlist-header-container h2 {
    margin: 0;
    padding-left: 0;
    border-left: none;
    flex: 1;
}

/* Style sp√©cifique pour le bouton de partage en haut de page */
.playlist-header-container .btn-share {
    margin-left: 15px;
}
        
/* Style des liens dans la description */
.playlist-description-content a {
    color: var(--primary); /* Utilise ton jaune dor√© */
    text-decoration: underline;
    text-underline-offset: 3px;
    transition: opacity 0.2s;
}

.playlist-description-content a:hover {
    opacity: 0.8;
    text-decoration: none;
}

/* Optionnel : Si tu pr√©f√®res un bleu tr√®s doux √† la place du jaune */
        
/* --- Bloc Description Ultra-L√©ger --- */
.playlist-description-container {
    margin: 20px 0;
    padding: 18px 20px;
    border-radius: 16px;
    cursor: pointer;
    overflow: hidden;
    position: relative;
    height: 130px;
    transition: all 0.5s ease;
    /* Supprime le rectangle bleu au clic sur mobile (Chrome/Safari/Android) */
    -webkit-tap-highlight-color: transparent;
    
    /* Supprime la bordure de s√©lection (focus) sur certains navigateurs */
    outline: none;
    
    /* Emp√™che la s√©lection accidentelle du texte pendant le clic */
    -webkit-user-select: none;
    user-select: none;

    /* On enl√®ve tout fond sombre */
    background: rgba(255, 255, 255, 0.03);
    border: none !important;

    /* LA SOLUTION : Un masque de transparence au lieu d'une couleur noire */
    -webkit-mask-image: linear-gradient(to bottom, black 60%, transparent 100%);
    mask-image: linear-gradient(to bottom, black 60%, transparent 100%);
}

.playlist-description-container.expanded {
    height: auto;
    min-height: 130px;
    /* On retire le masque quand c'est ouvert pour tout voir */
    -webkit-mask-image: none;
    mask-image: none;
    background: rgba(255, 255, 255, 0.06);
}

.playlist-description-content {
    font-size: 0.92rem;
    line-height: 1.5;
    /* On rend le texte un peu plus gris/transparent pour moins trancher */
    color: rgba(234, 234, 234, 0.6); 
}

.read-more-hint {
    color: var(--primary); 
    font-size: 0.65rem; 
    font-weight: bold;
    text-transform: uppercase; 
    margin-top: 8px; 
    display: none; 
    letter-spacing: 1.2px;
    opacity: 0.8;
}
        
/* ===================== */
/*      √âPISODES         */
/* ===================== */

/* Container pour le titre √âpisodes et son bouton partage */
.episodes-header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 25px;
    margin-bottom: 10px;
}

.episodes-header-row h3 {
    margin: 0 !important;
}

/* Style du bouton retour en haut √† c√¥t√© du titre principal */
.btn-go-up {
    background: rgba(210, 179, 71, 0.15);
    border: 1px solid rgba(243,195,0,0.6);
    color: var(--primary);
    border-radius: 50%;
    width: 37px;  /* On l'agrandit un peu pour le mobile */
    height: 37px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    padding: 0;
    line-height: 1;
    flex-shrink: 0;
}

.btn-go-up span {
    font-style: normal !important; /* Force le retrait de l'italique */
    font-size: 22px;               /* Taille de la fl√®che */
    font-weight: bold;
    display: inline-block;
    transform: translateY(-1px);   /* Ajustement optique pour le centrage */
}

.btn-go-up:hover {
    background: var(--primary);
    color: #000;
}
.episode-item{
  margin-bottom:10px;
  padding:16px 20px;
  border-radius:16px;

  display:flex;
  align-items:center;
  justify-content:space-between;

  cursor:pointer;
  border-left:0 solid var(--primary);
  transition:all .25s ease;
        /* Supprime le rectangle bleu sur mobile */
  -webkit-tap-highlight-color: transparent;
  
  /* Supprime le contour de s√©lection au focus (clavier/accessibilit√©) */
  outline: none;
}

.episode-item:hover{
  background:
    linear-gradient(160deg,
      rgba(255,255,255,0.08),
      rgba(255,255,255,0.02));
}

.episode-item.current{
  border-left:6px solid var(--primary);

  box-shadow:
    0 5px 15px rgba(0,0,0,0.35);
}

.episode-title {
  flex: 1;              /* Prend l'espace disponible */
  margin-right: 20px;   /* Espace minimal entre la fin du texte et le bouton */
  font-size: 1rem;
  text-align: left;
  
  /* Permet au texte de passer √† la ligne suivante */
  white-space: normal;  
  word-wrap: break-word; 
  line-height: 1.4;
}

/* bouton partage */
.btn-share {
  flex-shrink: 0;       /* EMP√äCHE le bouton de s'√©craser si le titre est long */
  background: transparent;
  border: 1px solid rgba(243,195,0,0.6);
  color: var(--primary);
  width: 34px;
  height: 34px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all .3s ease;
  animation: pulse-border 12s infinite ease-in-out;
      /* Supprime le rectangle bleu sur mobile */
  -webkit-tap-highlight-color: transparent;
  
  /* Supprime le contour de s√©lection au focus (clavier/accessibilit√©) */
  outline: none;
}

.heart-empty {
    font-size: 1.3rem; /* L√©g√®rement plus grand */
    font-weight: 900;  /* Plus gras */
    display: inline-block;
    transform: scaleX(1.1); /* √âlargit un peu le symbole horizontalement */
}

@keyframes pulse-border {
  0%, 100% { border-color: rgba(243, 195, 0, 0.25); box-shadow: 0 8px 20px rgba(0,0,0,0.35); }
  50% { border-color: rgba(243, 195, 0, 0.5); box-shadow: 0 0 15px rgba(243, 195, 0, 0.15); }
}

.btn-share:hover{
  background:var(--primary);
  color:#111;
}

/* L'OMBRE DU LECTEUR (Plus petite et naturelle) */
.player-container {
    position: fixed;
    height: 130px;
    bottom: 0;
    left: 0;
    right: 0;
    background: #0b0e14;
    border-radius: 40px 40px 0 0 / 25px 25px 0 0;
    border-top: 1px solid rgba(243, 195, 0, 0.3);
    /* On garde du padding sur les c√¥t√©s, mais ZERO en bas pour coller la barre */
    padding: 0px 0px 0px; 
    box-shadow: 0 -10px 25px rgba(0, 0, 0, 0.5);
    animation: playerSubtleWave 15s ease-in-out infinite;
}
/* --- LE TITRE (Espace r√©tabli) --- */
.now-playing {
    text-align: center;
    font-size: 0.85rem;
    font-weight: 700;
    color: var(--primary);
    margin-top: 40px; 
    margin-bottom: 25px;
    padding: 0 20px; /* Pour ne pas que le texte touche les bords */
}

/* --- LE LECTEUR AUDIO (Espace avec le titre) --- */
audio {
    width: 100%;
    height: 40px;
    filter: invert(100%) hue-rotate(180deg) brightness(1.5) contrast(0.9);
    border-radius: 15px;
    /*margin-bottom: 2px; /* Petit espace en bas */
}

/* --- ANIMATIONS RENFORC√âES (Visibles) --- */
@keyframes borderPulse {
    0%, 100% { 
        border-color: rgba(243, 195, 0, 0.25); 
        box-shadow: 0 0 12px rgba(243, 195, 0, 0.08);
    }
    50% { 
        border-color: rgba(243, 195, 0, 0.45);
        box-shadow: 0 0 18px rgba(243, 195, 0, 0.18);
    }
}


@keyframes playerSubtleWave {
    0%, 100% { 
        border-top-color: rgba(243, 195, 0, 0.25); 
    }
    50% { 
        border-top-color: rgba(243, 195, 0, 0.45); 
    }
}

/* ===================== */
/*       TOAST           */
/* ===================== */
#toast {
  opacity: 0;
  pointer-events: none;

  min-width: 200px;
  background: var(--primary);
  color: #111;
  text-align: center;
  border-radius: 30px;
  padding: 12px 18px;

  position: fixed;
  left: 50%;
  /* MODIFICATION ICI : on le remonte pour passer au-dessus de l'image */
  bottom: 260px; 
  /* On augmente aussi le z-index pour √™tre s√ªr qu'il soit au premier plan */
  z-index: 2000; 

  transform: translate(-50%, 12px);
  font-weight: 700;
  font-size: .8em;
  box-shadow: 0 10px 30px rgba(0,0,0,0.8);
  transition: opacity .35s ease, transform .35s ease;
}

#toast.show{
  opacity:1;
  transform:translate(-50%, 0);
}


.loader{
  text-align:center;
  color:var(--primary);
  padding:24px;
  font-style:italic;
}
/* =============================== */
/* LECTEUR AUDIO INTERNE BSG       */
/* =============================== */

.bsg-audio-player {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    gap: 5px;
}

/* On superpose le bouton sur la barre */
.bsg-progress-row {
    display: flex;
    flex-direction: column; /* On empile les √©l√©ments verticalement */
    width: 100%;
    padding: 0; 
}

.bsg-whale-btn {
    position: fixed; /* Fix√© par rapport √† l'√©cran */
    bottom: 0;      /* Colle au bord bas */
    left: 50%;
    transform: translateX(-50%); /* Centrage horizontal parfait */
    
    /* Suppression du fond et de la bordure */
    background: none !important;
    border: none !important;
    box-shadow: none !important;
    
    width: 180px;  /* Augment√© un peu pour l'effet visuel */
    height: 140px;
    z-index: 10000; /* Passe au-dessus de tout le reste */
    cursor: pointer;
    outline: none;
    -webkit-tap-highlight-color: transparent;
    
    /* Supprimez le margin-bottom pour bien toucher le bord */
    bottom: -10px; 
    padding: 0;
    /* AJOUT DE LA TRANSPARENCE ICI */
    opacity: 1; /* 1 est opaque, 0 est invisible */
    
    /* Transition pour que le changement de transparence soit fluide au survol */
    transition: opacity 0.3s ease, transform 0.3s ease;
}

.bsg-whale-btn img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    object-position: bottom; 
    /* Ombre blanche douce par d√©faut pour d√©tacher le noir du fond */
    filter:
    drop-shadow(0 -3px 6px rgba(255, 255, 255, 0.5))
    drop-shadow(0 1px 2px rgba(255, 255, 255, 0.3));
    transition: filter 0.3s ease, transform 0.3s ease;

} 


/* Effet plus lumineux quand on joue la musique */
.bsg-audio-player.is-playing .bsg-whale-btn img {
    filter:
    drop-shadow(0 -3px 6px rgba(243, 195, 0, 0.6))
    drop-shadow(0 1px 2px rgba(243, 195, 0, 0.4));
    transition: filter 0.3s ease, transform 0.3s ease;
}

.bsg-time-container {
    margin-top: 60px; 
    display: flex;
    justify-content: space-between;
    padding: 0 10px;
    /* On utilise une marge n√©gative pour aspirer les chiffres vers le bas */
    position: relative;
    pointer-events: none; /* Pour que le clic traverse les chiffres et atteigne la barre */
}
        
.bsg-time {
    /* Police l√©g√®re et √©l√©gante pour l'aspect v√©g√©tal */
    font-family: "Segoe UI Semilight", "Helvetica Neue", sans-serif;
    font-weight: 100; 
    font-size: 1.5rem; /* Chiffres plus grands */
    color: rgba(210, 179, 71, 0.4);
    font-variant-numeric: tabular-nums;
    letter-spacing: 1px;
}

/* --- Vague --- */
.bsg-wave {
    height: 25px;
    cursor: pointer;
    width: 100vw;
    display: flex;
    align-items: center;
    position: relative;
}

.bsg-wave svg {
    width: 100%;
    height: 100%; /* Le SVG prend toute la place du conteneur r√©duit */
}

#wave-bg {
    fill: none;
    stroke: rgba(255,255,255,0.18);
    stroke-width: 3;
}

#wave-progress {
    fill: none;
    stroke: #f3c300;
    stroke-width: 4;
    stroke-linecap: round;
    stroke-dasharray: 600;
    stroke-dashoffset: 600;
    transition: stroke-dashoffset 0.12s linear;
}


</style>
</head>
<body>

<nav class="nav-dock">
    <a href="https://baleinesousgravillon.com/" target="_blank" class="site-image-link" title="Baleine sous Gravillon">
        <img src="https://image.ausha.co/CQMRa8hZ950ZAamQlgLxjsA38VuxGAXyvYCZXFXK_400x400.jpeg" alt="BSG">
    </a>
    <a href="https://baleinesousgravillon.com/" target="_blank" class="site-image-link" title="Combats">
        <img src="https://image.ausha.co/A7P2IR07j1IuiB6cAAY9LjKIEcrbr4dPsgqobQHP_400x400.jpeg" alt="Combats">
    </a>
    <a href="https://baleinesousgravillon.com/" target="_blank" class="site-image-link" title="Petit Poisson">
        <img src="https://image.ausha.co/CBnPjfz7mxzBMJg4Fc3OGIHETweeY5jv4GH5JdU0_400x400.jpeg" alt="PPDV">
    </a>
    <a href="https://baleinesousgravillon.com/" target="_blank" class="site-image-link" title="Nomen">
        <img src="https://image.ausha.co/0xC11gNAqCw0Flp5qCUhuWM9kJI3p8Lw6J3lLm5w_400x400.jpeg" alt="Nomen">
    </a>
    <a href="https://baleinesousgravillon.com/" target="_blank" class="site-image-link" title="M√©caniques du vivant">
        <img src="https://baleinesousgravillon.com/wp-content/uploads/2023/09/podcast-5-300x300.jpg" alt="Nomen">
    </a>

</nav>

<div class="container">
    <div id="seasons_grid" class="grid-list"></div>
    <div id="episodes_list"></div>
</div>
<a href="https://baleinesousgravillon.com/" target="_blank" id="logo-link">
    <img id="player-img" class="is-logo" src="https://raw.githubusercontent.com/bsg-univers/lecteur-bsg/refs/heads/main/media/logo-BSG.png" alt="Logo">
</a>
<div class="player-container">

<div class="bsg-audio-player" data-player>
    <button id="whale-btn" class="bsg-whale-btn" aria-label="Lecture / Pause">
        <img src="https://raw.githubusercontent.com/bsg-univers/lecteur-bsg/refs/heads/main/queue-baleine.png" alt="whale tail">
    </button>
    <div class="bsg-progress-row">
        <div class="bsg-time-container">
        <span class="bsg-time" id="current-time">0:00</span>
        <span class="bsg-time" id="duration">0:00</span>
        </div>

        <div class="bsg-wave" id="wave-track" aria-label="Progression audio">
        <svg viewBox="0 0 600 60" preserveAspectRatio="none">
            <path id="wave-bg"
                  d="M0 30 Q 30 22 60 30 T 120 30 T 180 30 T 240 30 T 300 30 T 360 30 T 420 30 T 480 30 T 540 30 T 600 30" />
            <path id="wave-progress"
                  d="M0 30 Q 30 22 60 30 T 120 30 T 180 30 T 240 30 T 300 30 T 360 30 T 420 30 T 480 30 T 540 30 T 600 30" />
        </svg>
        </div>
    </div>
</div>

<audio id="player" preload="metadata" playsinline></audio>

<script>
    
// --- CONFIGURATION ---
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyoj1HRP-nYuZW5YHoaNXLw64iLvbcK9Q-Wxj5hN6CgPNqNt6vXlrV9qfqBcyBRzRiH0A/exec";
let episodes = [];
let current = 0;
let allPlaylists = [];

const audio = document.getElementById('player');
const titleDisplay = document.getElementById('now-playing-title');

const whaleBtn = document.getElementById('whale-btn');
const waveTrack = document.getElementById('wave-track');
const waveProgress = document.getElementById('wave-progress');
const currentTimeEl = document.getElementById('current-time');
const durationEl = document.getElementById('duration');
const uiPlayer = document.querySelector('.bsg-audio-player');

let isScrubbing = false;
let currentSeason = null;

/* --- Play / Pause --- */
whaleBtn.addEventListener('click', () => {
    audio.paused ? audio.play() : audio.pause();
});

audio.addEventListener('play', () => uiPlayer.classList.add('is-playing'));
audio.addEventListener('pause', () => uiPlayer.classList.remove('is-playing'));

/* --- Dur√©e --- */
audio.addEventListener('loadedmetadata', () => {
    durationEl.textContent = formatTime(audio.duration);
});

/* --- Progression --- */
audio.addEventListener('timeupdate', () => {
    if (isScrubbing || !audio.duration) return;
    updateProgress(audio.currentTime / audio.duration);
});

/* --- Scrub clic + drag --- */
const seek = (clientX) => {
    const rect = waveTrack.getBoundingClientRect();
    const ratio = Math.min(Math.max(0, clientX - rect.left), rect.width) / rect.width;
    audio.currentTime = ratio * audio.duration;
    updateProgress(ratio);
};

waveTrack.addEventListener('pointerdown', e => {
    isScrubbing = true;
    audio.pause();
    seek(e.clientX);
});

window.addEventListener('pointerup', () => {
    if (isScrubbing && audio.currentTime < audio.duration) {
        audio.play();
    }
    isScrubbing = false;
});

window.addEventListener('pointermove', e => {
    if (isScrubbing) seek(e.clientX);
});


/* --- UI --- */
function updateProgress(ratio) {
    waveProgress.style.strokeDashoffset = 600 - ratio * 600;
    currentTimeEl.textContent = formatTime(audio.currentTime);
}

function formatTime(t) {
    if (!Number.isFinite(t)) return "0:00";
    const m = Math.floor(t / 60);
    const s = Math.floor(t % 60).toString().padStart(2, '0');
    return `${m}:${s}`;
}


// --- MEDIA SESSION : handlers d√©clar√©s UNE SEULE FOIS ---
if ('mediaSession' in navigator) {
    navigator.mediaSession.setActionHandler('play', () => audio.play());
    navigator.mediaSession.setActionHandler('pause', () => audio.pause());
    navigator.mediaSession.setActionHandler('previoustrack', () => {
        if (current > 0) play(current - 1);
    });
    navigator.mediaSession.setActionHandler('nexttrack', () => {
        if (current + 1 < episodes.length) play(current + 1);
    });
    navigator.mediaSession.setActionHandler('seekbackward', (d) => {
        audio.currentTime -= (d.seekOffset || 10);
    });
    navigator.mediaSession.setActionHandler('seekforward', (d) => {
        audio.currentTime += (d.seekOffset || 10);
    });
}

async function loadJSON(file) {
  // On ajoute ?v= et l'heure actuelle pour ignorer le cache
  const res = await fetch(`data/${file}?v=${new Date().getTime()}`);
  return await res.json();
}


// --- PLAYLISTS ---
async function loadPlaylists() {
    const urlParams = new URLSearchParams(window.location.search);
    const initialPlaylistId = urlParams.get('playlistId')
        ? decodeURIComponent(urlParams.get('playlistId').replace(/\+/g, ' '))
        : null;

    allPlaylists = (await loadJSON("playlists.json")).filter(p => p.public);

    const seasons = [...new Set(allPlaylists.map(p => p.season))].sort().reverse();
    const grid = document.getElementById('seasons_grid');

    // Remplace cette partie :
    grid.innerHTML = seasons.map(s =>
        `<div class="season-item" onclick="showPlaylistsBySeason('${s}')">${s.replace(/saison\s?/i, '')}</div>`
    ).join('');
        // --- D√©synchronisation des galets (float organique) ---
    const seasonItems = grid.querySelectorAll('.season-item');
    
    seasonItems.forEach(item => {
      item.style.setProperty('--i', Math.random() * 6);
    });


    if (initialPlaylistId) {
        const shared = allPlaylists.find(p => String(p.id).trim() === initialPlaylistId.trim());
        if (shared) {
            showPlaylistsBySeason(shared.season);
            loadEpisodes(shared.id);
            return;
        }
    }

    showPlaylistsBySeason(seasons[0]);
}

 function resetPlayerImage() {
    const pImg = document.getElementById('player-img');
    if (pImg) {
        pImg.src = "https://raw.githubusercontent.com/bsg-univers/lecteur-bsg/refs/heads/main/media/logo-BSG.png";
        pImg.classList.remove('is-episode', 'zoomed');
        pImg.classList.add('is-logo');
    }
}
    
function showPlaylistsBySeason(season) {
    currentSeason = season;
    const dock = document.querySelector('.nav-dock');
    if (dock) dock.classList.remove('is-static');

    resetPlayerImage();

    // Gestion de l'√©tat actif des boutons de saison
    document.querySelectorAll('.season-item').forEach(btn => {
        const active = btn.innerText === season;
        btn.style.borderColor = active ? "var(--primary)" : "rgba(243,195,0,0.2)";
        btn.style.background = active ? "rgba(243,195,0,0.15)" : "rgba(255,255,255,0.03)";
    });

    const list = allPlaylists.filter(p => p.season === season);
    const div = document.getElementById('episodes_list');

    // STRUCTURE DE LA PAGE
    // On cr√©e l'en-t√™te, la barre de recherche et SURTOUT le conteneur vide pour les playlists
    div.innerHTML = `
        <div class="season-title-container">
            <h2 id="view-title">${season}</h2>
            <div style="display: flex; gap: 6px; align-items: center;">
                <div class="btn-explore-themes" onclick="showSavedList('favorites')" title="Mes Favoris" 
                     style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; padding: 0; font-size: 1.2rem;">
                    ‚ù§Ô∏è
                </div>
                <div class="btn-explore-themes" onclick="showSavedList('later')" title="√Ä regarder plus tard" 
                     style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; padding: 0; font-size: 1.2rem;">
                    üïí
                </div>
                <div class="btn-explore-themes" onclick="toggleHashtagLibrary()" title="Explorer par th√©matiques"
                     style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; padding: 0; font-size: 1.2rem;">
                    ü§ø
                </div>
            </div>
        </div>
        <div class="search-container">
            <input 
                type="text" 
                id="playlist-search" 
                placeholder="Rechercher une playlist..."
                autocomplete="off"
            >
        </div>
        <div id="hashtag-library" style="display: none; margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 15px; border: 1px solid rgba(210, 179, 71, 0.1);">
            <div id="hashtag-cloud" style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: flex-start;"></div>
        </div>
        
        <div id="playlists-container"></div>
    `;

    // 1. On affiche la liste initiale
    renderFilteredPlaylists(list);

    // 2. On active la barre de recherche
    initSearchBar();
}

function renderFilteredPlaylists(list, isGlobalSearch = false) {
    const container = document.getElementById('playlists-container');
    if (!container) return;

    container.innerHTML = "";

    if (list.length === 0) {
        container.innerHTML = `<div style="text-align:center; padding: 40px; opacity: 0.5;">Aucun r√©sultat trouv√© dans toutes les saisons...</div>`;
        return;
    }

    list.forEach(p => {
        const encoded = btoa(unescape(encodeURIComponent(p.id)));
        const banner = document.createElement('div');
        banner.className = 'playlist-banner';
        banner.onclick = () => loadEpisodes(encoded, true);

        // Si c'est une recherche globale, on pr√©pare un petit badge pour la saison
        const seasonBadge = isGlobalSearch 
            ? `<span class="season-badge">${p.season}</span>` 
            : "";

        const hashtagsHtml = p.hashtags
            ? `<div class="playlist-tags-area">
                ${p.hashtags.split(' ').filter(t => t.trim() !== "").map(tag =>
                    `<span class="tag-mini" data-tag="${tag}">#${tag}</span>`
                ).join('')}
               </div>`
            : "";

        banner.innerHTML = `
            <div class="playlist-top-row">
                <img src="${p.image || ''}" class="playlist-thumb">
                <div class="playlist-info">
                    <span class="playlist-name-text"><strong>${p.name}</strong></span>
                    ${seasonBadge}
                </div>
                <button class="btn-share">üîó</button>
            </div>
            ${hashtagsHtml}
        `;

        // ... (reste de votre logique de clic share et tags identique) ...
        banner.querySelector('.btn-share').onclick = (e) => { e.stopPropagation(); sharePlaylist(e, encoded); };
        banner.querySelectorAll('.tag-mini').forEach(tagEl => {
            tagEl.onclick = (e) => { e.stopPropagation(); filterByHashtag(e, tagEl.dataset.tag); };
        });

        container.appendChild(banner);
    });
}

function initSearchBar() {
    const input = document.getElementById('playlist-search');
    if (!input) return;

    const performSearch = () => {
        const query = input.value.toLowerCase().trim();

        if (query === "") {
            // Si la barre est vide, on revient √† l'affichage de la saison actuelle
            const defaultList = allPlaylists.filter(p => p.season === currentSeason);
            renderFilteredPlaylists(defaultList);
            return;
        }

        // RECHERCHE GLOBALE : On filtre sur TOUTES les playlists
        const filtered = allPlaylists.filter(p => {
            const matchText =
                p.name.toLowerCase().includes(query) ||
                (p.hashtags && p.hashtags.toLowerCase().includes(query));
            return matchText;
        });

        renderFilteredPlaylists(filtered, true); // On ajoute un badge "isGlobal"
    };

    input.addEventListener('input', performSearch);
    input.addEventListener('keydown', (e) => {
        if (e.key === "Enter") {
            e.preventDefault();
            performSearch();
        }
    });
}

// Appelez cette fonction au chargement
window.addEventListener('DOMContentLoaded', resetPlayerImage);
function toggleHashtagLibrary() {
    const library = document.getElementById('hashtag-library');
    const cloud = document.getElementById('hashtag-cloud');
    
    if (library.style.display === 'block') {
        library.style.display = 'none';
        return;
    }

    let allTags = [];
    allPlaylists.forEach(p => {
        if (p.hashtags) {
            // On s√©pare par espace et on nettoie les tags vides
            const tags = p.hashtags.split(' ').filter(t => t.trim() !== "");
            allTags = allTags.concat(tags);
        }
    });

    // Nettoyage : d√©doublonnage et tri alphab√©tique
    const uniqueTags = [...new Set(allTags)].sort((a, b) => a.localeCompare(b));

    // Utilisation de la classe .tag-mini pour la coh√©rence visuelle
    cloud.innerHTML = uniqueTags.map(tag => `
        <span class="tag-mini" style="cursor:pointer; padding: 5px 12px; font-size: 0.85rem;" onclick="filterByHashtag(event, '${tag}')">
            #${tag}
        </span>
    `).join('');

    library.style.display = 'block';
}
    
function filterByHashtag(event, tag) {
    if (event) event.stopPropagation(); // Emp√™che d'ouvrir la playlist si on clique sur un tag
    
    const div = document.getElementById('episodes_list');
    // On change le titre pour indiquer le filtre actif
    div.innerHTML = `
        <div class="season-title-container">
            <h2>#${tag}</h2>
            <div class="btn-explore-themes" onclick="showPlaylistsBySeason(allPlaylists[0].season)" title="Retour">
                ‚úï
            </div>
        </div>
    `;

    // On filtre les playlists qui contiennent ce hashtag
    const filtered = allPlaylists.filter(p => p.hashtags && p.hashtags.includes(tag));

    div.innerHTML += filtered.map(p => {
        const encoded = btoa(unescape(encodeURIComponent(p.id)));

        // On pr√©pare les hashtags pour la ligne du bas
        const hashtagsHtml = p.hashtags
            ? `<div class="playlist-tags-area">
                ${p.hashtags.split(' ').filter(t => t.trim() !== "").map(t =>
                    `<span class="tag-mini ${t === tag ? 'active-tag' : ''}" onclick="filterByHashtag(event, '${t}')">#${t}</span>`
                ).join('')}
               </div>`
            : "";

        return `
            <div class="playlist-banner" onclick="loadEpisodes('${encoded}', true)">
                <div class="playlist-top-row">
                    <img src="${p.image || ''}" class="playlist-thumb" alt="thumbnail">
                    <span class="playlist-name-text"><strong>${p.name}</strong></span>
                    <button class="btn-share" onclick="sharePlaylist(event, '${encoded}')">üîó</button>
                </div>
                
                ${hashtagsHtml}
            </div>`;
    }).join('');

    window.scrollTo({ top: 0, behavior: 'smooth' });
}
    
// --- PARTAGE NATIF + COPIE ---
async function sharePlaylist(e, encodedPid) {
    if (e) e.stopPropagation();
    
    // On d√©code l'ID pour avoir le nom en clair (ex: "Les Baleines")
    const pid = decodeURIComponent(escape(atob(encodedPid)));
    
    // On construit l'URL proprement
    const url = new URL(window.location.origin + window.location.pathname);
    
    // IMPORTANT : On utilise le nom en clair 'pid' comme dans votre version originale
    url.searchParams.set('playlistId', pid); 
    const shareUrl = url.toString();

    const shareData = {
        title: 'Baleine sous gravillon',
        text: `√âcoutez cette s√©rie : ${pid}`,
        url: shareUrl
    };

    try {
        if (navigator.share) {
            await navigator.share(shareData);
        } else {
            await navigator.clipboard.writeText(shareUrl);
            showToast("Lien de la s√©rie copi√© !");
        }
    } catch (err) {
        // En cas d'erreur ou d'annulation sur mobile, on copie en secours
        await navigator.clipboard.writeText(shareUrl);
        if (err.name !== 'AbortError') {
            showToast("Lien copi√© dans le presse-papier");
        }
    }
}

function showToast(message) {
    const toast = document.getElementById("toast");
    // On met √† jour le texte du toast avec le message re√ßu
    toast.innerText = message;
    toast.className = "show";
    
    setTimeout(() => { 
        toast.className = ""; 
    }, 3000);
}

// --- GESTION DES LISTES LOCALES ---

// Initialisation des donn√©es si elles n'existent pas
if (!localStorage.getItem('bsg_favorites')) localStorage.setItem('bsg_favorites', JSON.stringify([]));
if (!localStorage.getItem('bsg_later')) localStorage.setItem('bsg_later', JSON.stringify([]));

function toggleSave(listType, playlistId, btn) {
    const key = 'bsg_' + listType;
    let items = JSON.parse(localStorage.getItem(key) || "[]");
    const index = items.indexOf(playlistId);
    let message = "";

    if (index > -1) {
            // SUPPRESSION
            items.splice(index, 1);
            if (listType === 'favorites') {
                // On utilise un span pour appliquer l'√©largissement au symbole vide
                btn.innerHTML = '<span class="heart-empty">‚ô°</span>';
                message = "Retir√© des favoris";
            } else {
                btn.innerText = '‚ûï';
                message = "Retir√© de '√Ä regarder plus tard'";
            }
        } else {
            // AJOUT
            items.push(playlistId);
            if (listType === 'favorites') {
                btn.innerText = '‚ù§Ô∏è';
                message = "Ajout√© aux favoris !";
            } else {
                btn.innerText = 'üïí';
                message = "Ajout√© √† '√Ä regarder plus tard'";
            }
        }

    localStorage.setItem(key, JSON.stringify(items));
    showToast(message);

    // Si on est dans la vue "Liste", on rafra√Æchit pour masquer l'√©l√©ment supprim√©
    const currentTitle = document.getElementById('view-title')?.innerText || "";
    if (currentTitle.includes("Mes") || currentTitle.includes("Regarder")) {
        showSavedList(listType);
    }
}
function resetMediaState() {
    audio.pause();
    audio.src = "";
    
    if ('mediaSession' in navigator) {
        navigator.mediaSession.metadata = null;
    }
}
    
function showSavedList(listType) {
    const key = 'bsg_' + listType;
    const savedIds = JSON.parse(localStorage.getItem(key) || "[]");
    const div = document.getElementById('episodes_list');
    const title = listType === 'favorites' ? 'Mes Favoris ‚ù§Ô∏è' : '√Ä regarder plus tard üïí';
    
    // Ent√™te de la liste avec bouton retour
    div.innerHTML = `
        <div class="season-title-container">
            <h2 id="view-title">${title}</h2>
            <div class="btn-explore-themes" onclick="resetMediaState(); loadPlaylists()" title="Retour">‚úï</div>
        </div>
    `;

    // On cherche les objets playlist correspondants aux IDs sauv√©s
    const filtered = allPlaylists.filter(p => savedIds.includes(String(p.id)));

    if (filtered.length === 0) {
        div.innerHTML += `<p style="text-align:center; padding:40px; opacity:0.5;">Votre liste est vide.</p>`;
        return;
    }

    // Affichage des cartes
    filtered.forEach(p => {
        const encoded = btoa(unescape(encodeURIComponent(p.id)));
        div.innerHTML += `
            <div class="playlist-banner" onclick="loadEpisodes('${encoded}', true)">
                <div class="playlist-top-row">
                    <img src="${p.image || ''}" class="playlist-thumb">
                    <span class="playlist-name-text"><strong>${p.name}</strong></span>
                    <div style="display:flex; gap:5px;">
                         <button class="btn-share" onclick="event.stopPropagation(); toggleSave('${listType}', '${p.id}', this)">
                            ${listType === 'favorites' ? '‚ù§Ô∏è' : 'üïí'}
                         </button>
                         <button class="btn-share" onclick="sharePlaylist(event, '${encoded}')">üîó</button>
                    </div>
                </div>
            </div>`;
    });
    
    window.scrollTo({top: 0, behavior: 'smooth'});
}

// Fonction utilitaire pour g√©n√©rer le HTML d'une carte (pour √©viter la r√©p√©tition)
function renderPlaylistCard(p, encoded) {
    return `
        <div class="playlist-banner" onclick="loadEpisodes('${encoded}', true)">
            <div class="playlist-top-row">
                <img src="${p.image || ''}" class="playlist-thumb" alt="thumbnail">
                <div class="playlist-info" style="flex:1; margin-left:10px;">
                    <span class="playlist-name-text"><strong>${p.name}</strong></span>
                </div>
                <div style="display: flex; gap: 5px;">
                    <button class="btn-share" style="background: rgba(255,255,255,0.1);" 
                        onclick="event.stopPropagation(); toggleSave('favorites', '${p.id}', this)">
                        ${JSON.parse(localStorage.getItem('bsg_favorites')).includes(p.id) ? '‚ù§Ô∏è' : '‚ô°'}
                    </button>
                    <button class="btn-share" onclick="sharePlaylist(event, '${encoded}')">üîó</button>
                </div>
            </div>
        </div>`;
}

// --- FONCTION COMPL√àTE : CHARGEMENT DES √âPISODES AVEC LISTES PERSO ---
async function loadEpisodes(pid, encoded = false) {
    // 1. Gestion de l'affichage du dock
    const dock = document.querySelector('.nav-dock');
    if (dock) dock.classList.add('is-static');
    
    // 2. D√©codage de l'ID de la playlist
    const cleanId = encoded 
        ? decodeURIComponent(escape(atob(pid))) 
        : pid;

    const div = document.getElementById('episodes_list');
    div.innerHTML = '<div class="loader">Plong√©e...</div>';

    try {
        // 3. R√©cup√©ration des donn√©es de la playlist et des listes locales
        const currentPl = allPlaylists.find(p => String(p.id).trim() === cleanId.trim());
        const playlistDesc = currentPl ? currentPl.description : "";
        
        // Lecture du localStorage pour l'√©tat des boutons
        const savedFavs = JSON.parse(localStorage.getItem('bsg_favorites') || "[]");
        const savedLater = JSON.parse(localStorage.getItem('bsg_later') || "[]");
        const isFav = savedFavs.includes(cleanId);
        const isLater = savedLater.includes(cleanId);

        // 4. Charger les √©pisodes depuis le JSON
        const res = await fetch(`data/episodes.json?v=${new Date().getTime()}`);
        const allEpisodes = await res.json();

        // Filtrer et trier les √©pisodes de cette playlist
        episodes = allEpisodes
            .filter(e => String(e.playlistId).trim() === cleanId.trim())
            .sort((a, b) => (a.order || 0) - (b.order || 0));

        if (!episodes.length) {
            div.innerHTML = '<p style="text-align:center; padding:20px;">Aucun √©pisode trouv√©.</p>';
            return;
        }

        const headerEncoded = btoa(unescape(encodeURIComponent(cleanId)));
        
        // 5. Construction des Hashtags
        const hashtagsHtml = (currentPl && currentPl.hashtags) 
            ? `<div class="playlist-tags-area">
                ${currentPl.hashtags.split(' ').filter(t => t.trim() !== "").map(tag => 
                    `<span class="tag-mini" onclick="filterByHashtag(event, '${tag}')">#${tag}</span>`
                ).join('')}
               </div>` 
            : "";
        
        // 6. Construction du HTML de l'en-t√™te
        let html = `
            <div class="playlist-header-container">
                <h2>${cleanId}</h2>
                <button class="btn-go-up" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 19V5M5 12l7-7 7 7"/>
                    </svg>
                </button>
            </div>
            ${hashtagsHtml} 
        `;
        
        // Bloc Description
        if (playlistDesc && playlistDesc.trim() !== "") {
            html += `
            <div class="playlist-description-container" id="desc-container" onclick="this.classList.toggle('expanded')">
                <div class="playlist-description-content">
                    ${playlistDesc}
                </div>
                <span class="read-more-hint">Lire la suite...</span>
            </div>`;
        }
        
        // 7. LIGNE DES BOUTONS D'ACTION (Favoris, Plus tard, Partage)
        html += `
            <div class="episodes-header-row">
                <h3>√âpisodes</h3>
                <div style="display: flex; gap: 8px;">
                    <button class="btn-share" onclick="event.stopPropagation(); toggleSave('favorites', '${cleanId}', this)" title="Favoris">
                        ${isFav ? '‚ù§Ô∏è' : '<span class="heart-empty">‚ô°</span>'}
                    </button>
                    <button class="btn-share" onclick="toggleSave('later', '${cleanId}', this)" title="√Ä regarder plus tard">
                        ${isLater ? 'üïí' : '‚ûï'}
                    </button>
                    <button class="btn-share" onclick="sharePlaylist(event, '${headerEncoded}')" title="Partager cette s√©rie">
                        üîó
                    </button>
                </div>
            </div>` +
            // Liste des √©pisodes
            episodes.map((e, i) => `
                <div class="episode-item list-item-ep" id="ep-${i}" onclick="play(${i})">
                    <span class="episode-title">${e.title}</span>
                    <span style="color:var(--primary); font-size:0.8em;">‚ñ∂</span>
                </div>
            `).join('');

        div.innerHTML = html;

        // 8. Finalisation (Scroll et corrections de liens)
        setTimeout(() => {
            const titleSection = div.querySelector('.playlist-header-container');
            if (titleSection) {
                titleSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }, 50);

        const descLinks = div.querySelectorAll('.playlist-description-content a');
        descLinks.forEach(link => {
            link.setAttribute('target', '_blank');
            link.setAttribute('rel', 'noopener noreferrer');
        });        

        // Lecture auto du premier √©pisode
        play(0);

    } catch (err) {
        console.error('Erreur chargement episodes', err);
        div.innerHTML = '<p>Erreur de chargement des √©pisodes.</p>';
    }
}


async function play(i) {
    current = i;
    const episode = episodes[i];
    const pImg = document.getElementById('player-img');

    // 1. Mise √† jour imm√©diate du titre (avant m√™me le chargement audio)

    // 2. Gestion de l'image
    if (pImg) {
        pImg.classList.remove('zoomed');
        if (episode.image && episode.image.trim() !== "") {
            pImg.src = episode.image;
            pImg.classList.replace('is-logo', 'is-episode');
        } else {
            pImg.src = "https://raw.githubusercontent.com/bsg-univers/lecteur-bsg/refs/heads/main/media/logo-BSG.png";
            pImg.classList.replace('is-episode', 'is-logo');
        }
    }

    // 3. UI : S√©lection dans la liste
    document.querySelectorAll('.episode-item').forEach(el => el.classList.remove('current'));
    document.getElementById(`ep-${i}`)?.classList.add('current');

    // 4. Chargement Audio
    audio.src = episode.audio;
    
    try {
        await audio.play();
        updateMediaSession(episode.title);
    } catch (err) {
        console.error("Erreur lecture", err);
        // Si l'autostart est bloqu√© par Chrome, on laisse le titre mais on pr√©vient
        titleDisplay.innerText = episode.title;
    }

}


// --- MEDIA SESSION METADATA ---
function updateMediaSession(title) {
    if (!('mediaSession' in navigator)) return;

    navigator.mediaSession.metadata = new MediaMetadata({
        title,
        artist: "Baleine sous gravillon",
        album: "Le podcast du Vivant",
        artwork: [
            { src: 'https://raw.githubusercontent.com/bsg-univers/lecteur-bsg/refs/heads/main/media/logo-BSG.png', sizes: '270x270', type: 'image/png' },
            { src: 'https://image.ausha.co/CQMRa8hZ950ZAamQlgLxjsA38VuxGAXyvYCZXFXK_400x400.jpeg', sizes: '400x400', type: 'image/jpeg' }
        ]
    });
}

// --- GESTION DU WAKE LOCK (Emp√™cher la mise en veille profonde) ---
let wakeLock = null;
async function requestWakeLock() {
    try {
        if ('wakeLock' in navigator) {
            wakeLock = await navigator.wakeLock.request('screen');
        }
    } catch (err) {
        console.log("WakeLock non support√© ou refus√©");
    }
}
    
// --- √âV√âNEMENTS AUDIO ---
audio.addEventListener('play', () => {
    if ('mediaSession' in navigator) navigator.mediaSession.playbackState = "playing";
});

audio.addEventListener('pause', () => {
    if ('mediaSession' in navigator) navigator.mediaSession.playbackState = "paused";
});

// --- MODIFICATION DE L'√âV√âNEMENT ENDED ---
audio.addEventListener('ended', async () => {
    if (current + 1 < episodes.length) {
        // Petit d√©lai pour laisser le syst√®me respirer
        setTimeout(() => {
            play(current + 1);
        }, 500);
    }
});

// Relancer le WakeLock quand on reprend la lecture
audio.addEventListener('play', () => {
    requestWakeLock();
    if ('mediaSession' in navigator) navigator.mediaSession.playbackState = "playing";
});
    
// --- INIT ---
loadPlaylists();

if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').catch(err => console.log("Erreur SW", err));
}
    
document.addEventListener('click', function(e) {
    const pImg = document.getElementById('player-img');
    const pLink = document.getElementById('logo-link');
    if (!pImg) return;

    // Si on clique sur l'image
    if (e.target === pImg) {
        // SI C'EST UN √âPISODE : On g√®re le zoom et on bloque le lien
        if (pImg.classList.contains('is-episode')) {
            e.preventDefault(); // Emp√™che le lien de s'ouvrir
            pImg.classList.toggle('zoomed');
        } 
        // SI C'EST LE LOGO : On laisse le comportement par d√©faut (le lien s'ouvre)
    } 
    // Si on clique ailleurs alors que c'est zoom√©, on d√©zoome
    else if (pImg.classList.contains('zoomed')) {
        pImg.classList.remove('zoomed');
    }
});
    
window.addEventListener('scroll', function() {
    const logo = document.querySelector('.logo-main');
    if (logo) {
        let scrollPos = window.scrollY;
        // Le logo s'efface progressivement sur les 150 premiers pixels de scroll
        let opacity = 1 - (scrollPos / 150);
        logo.style.opacity = Math.max(opacity, 0);
    }
});
document.getElementById('player-img').src = "https://raw.githubusercontent.com/bsg-univers/lecteur-bsg/refs/heads/main/media/logo-BSG.png"; 
</script>
    <div id="toast">Lien de la s√©rie copi√© !</div>
</body>
</html>
