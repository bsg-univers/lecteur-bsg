<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baleine sous gravillon ‚Äì Player</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0b0e14">

    <style>
        /* Conserve ton CSS actuel, il est parfait */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root{ --primary:#f3c300; }
        body{ font-family:'Segoe UI',Roboto,sans-serif; color:#eaeaea; padding-bottom:160px; background-color:#0b0e14; min-height:100vh; background-image: radial-gradient(circle at 20% 30%, rgba(70,130,180,0.2), transparent 60%); }
        header { text-align: center; padding: 32px; background: rgba(0,0,0,0.6); }
        .logo-main{ max-width:200px; }
        .container{ max-width:820px; margin:auto; padding:20px; }
        h2,h3{ color:var(--primary); margin:30px 0 15px; border-left:3px solid var(--primary); padding-left:10px; }
        .grid-list{ display:grid; grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); gap:12px; }
        .season-item{ padding:15px; border-radius:12px; background:rgba(255,255,255,0.05); text-align:center; cursor:pointer; transition:0.3s; }
        .season-item:hover{ background:var(--primary); color:#000; }
        .episode-item{ margin-bottom:8px; padding:15px; border-radius:12px; display:flex; align-items:center; cursor:pointer; transition:0.2s; }
        .episode-item:hover{ background:rgba(255,255,255,0.08); }
        .episode-item.current{ border-left:5px solid var(--primary); background:rgba(255,255,255,0.05); }
        .episode-title{ flex-grow:1; }
        .btn-share { background:none; border:1px solid var(--primary); color:var(--primary); width:34px; height:34px; border-radius:50%; cursor:pointer; }
        .player-container{ position:fixed; bottom:0; width:100%; background:rgba(11,14,20,0.95); backdrop-filter:blur(15px); padding:20px; border-top:1px solid rgba(243,195,0,0.3); z-index:1000; }
        .now-playing{ text-align:center; color:var(--primary); font-size:0.9rem; margin-bottom:10px; }
        audio{ width:100%; }
        #toast{ position:fixed; bottom:120px; left:50%; transform:translateX(-50%); background:var(--primary); color:#000; padding:10px 20px; border-radius:20px; opacity:0; transition:0.4s; pointer-events:none; font-weight:bold; }
        #toast.show{ opacity:1; }
        .loader{ text-align:center; padding:20px; color:var(--primary); }
    </style>
</head>
<body>

<header>
    <img src="https://baleinesousgravillon.com/wp-content/uploads/2023/08/logo-accueil3Plan-de-travail-2-copie-3@2x-1.png" alt="Logo" class="logo-main">
</header>

<div class="container">
    <div id="seasons_grid" class="grid-list"></div>
    <div id="episodes_list"></div>
</div>

<div class="player-container">
    <div id="now-playing-title" class="now-playing">S√©lectionnez une aventure...</div>
    <audio id="player" style="border-radius: 15px;" controls playsinline preload="auto"></audio>
</div>

<div id="toast">Lien copi√© !</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwm-8iBh2aMDepvxSHpl0ywwlZpWIaEEh7veSNYyEG-X0gSalh6--vbhxyV4PR2GXMjvQ/exec";
let episodes = [];
let current = 0;
let allPlaylists = [];
let nextUrlCache = null; // Syst√®me de cache pour l'encha√Ænement fluide

async function callApi(params) {
    const response = await fetch(`${SCRIPT_URL}?${params}`);
    return await response.json();
}

async function loadPlaylists() {
    const urlParams = new URLSearchParams(window.location.search);
    const initialPlaylistId = urlParams.get('playlistId') ? decodeURIComponent(urlParams.get('playlistId').replace(/\+/g, ' ')) : null;

    allPlaylists = await callApi("action=getPlaylists");
    allPlaylists = allPlaylists.filter(p => p.public);

    const seasons = [...new Set(allPlaylists.map(p => p.season))].sort().reverse();
    const div = document.getElementById('seasons_grid');
    div.innerHTML = seasons.map(s => `<div class="season-item" onclick="showPlaylistsBySeason('${s.replace(/'/g, "\\'")}')">${s}</div>`).join('');

    if (initialPlaylistId) {
        const shared = allPlaylists.find(p => String(p.id).trim() === initialPlaylistId.trim());
        if (shared) {
            showPlaylistsBySeason(shared.season);
            loadEpisodes(shared.id);
        } else { showPlaylistsBySeason(seasons[0]); }
    } else { showPlaylistsBySeason(seasons[0]); }
}

function showPlaylistsBySeason(season) {
    const filtered = allPlaylists.filter(p => p.season === season);
    const div = document.getElementById('episodes_list');
    
    div.innerHTML = `<h2>Playlists ‚Äî ${season}</h2>` + filtered.map(p => {
        // SOLUTION APOSTROPHE : On encode l'ID pour le passer en toute s√©curit√©
        const encodedId = encodeURIComponent(p.id);
        return `<div class="episode-item">
            <span class="episode-title" onclick="loadEpisodes('${encodedId}')"><strong>${p.name}</strong></span>
            <button class="btn-share" onclick="sharePlaylist(event, '${encodedId}')">üîó</button>
        </div>`;
    }).join('');
}

function sharePlaylist(event, encodedPid) {
    event.stopPropagation();
    const pid = decodeURIComponent(encodedPid);
    const url = new URL(window.location.origin + window.location.pathname);
    url.searchParams.set('playlistId', pid);
    
    const textToCopy = url.toString();

    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(textToCopy).then(showToast);
    } else {
        const textArea = document.createElement("textarea");
        textArea.value = textToCopy;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showToast();
    }
}

function showToast() {
    const t = document.getElementById("toast");
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 3000);
}

async function loadEpisodes(encodedPid) {
    const pid = decodeURIComponent(encodedPid);
    const listDiv = document.getElementById('episodes_list');
    listDiv.innerHTML = '<div class="loader">Plong√©e...</div>';
    
    episodes = await callApi(`action=getEpisodes&playlistId=${encodeURIComponent(pid)}`);
    
    if (!episodes || episodes.length === 0) {
        listDiv.innerHTML = '<p>Aucun √©pisode trouv√©.</p>';
        return;
    }

    listDiv.innerHTML = `<h3>√âpisodes</h3>` + episodes.map((e, i) => `
        <div class="episode-item list-item-ep" id="ep-${i}" onclick="play(${i})">
            <span class="episode-title">${e.title}</span>
        </div>`).join('');
    play(0);
}

async function play(i) {
    current = i;
    nextUrlCache = null; // On vide le cache car on change de piste
    const audio = document.getElementById('player');
    const titleDisplay = document.getElementById('now-playing-title');
    
    document.querySelectorAll('.list-item-ep').forEach(el => el.classList.remove('current'));
    document.getElementById(`ep-${i}`)?.classList.add('current');
    titleDisplay.innerText = "‚åõ Connexion... " + episodes[i].title;

    const audioUrl = await callApi(`action=getAudio&guid=${episodes[i].guid}`);
    if (audioUrl) {
        audio.src = audioUrl;
        titleDisplay.innerText = episodes[i].title;
        audio.play();
        updateMediaSession(episodes[i].title);

        // --- PR√â-CHARGEMENT DU SUIVANT ---
        if (i + 1 < episodes.length) {
            callApi(`action=getAudio&guid=${episodes[i+1].guid}`).then(url => {
                nextUrlCache = url;
            });
        }
    }
}

function updateMediaSession(title) {
    if ('mediaSession' in navigator) {
        navigator.mediaSession.metadata = new MediaMetadata({
            title: title,
            artist: "Baleine sous gravillon",
            artwork: [{ src: 'https://image.ausha.co/CQMRa8hZ950ZAamQlgLxjsA38VuxGAXyvYCZXFXK_400x400.jpeg', sizes: '400x400', type: 'image/jpeg' }]
        });
        navigator.mediaSession.setActionHandler('nexttrack', () => { if(current+1 < episodes.length) play(current+1); });
        navigator.mediaSession.setActionHandler('previoustrack', () => { if(current-1 >= 0) play(current-1); });
    }
}

document.getElementById('player').onended = () => {
    if (current + 1 < episodes.length) {
        if (nextUrlCache) {
            // Encha√Ænement imm√©diat gr√¢ce au cache
            current++;
            const audio = document.getElementById('player');
            audio.src = nextUrlCache;
            document.getElementById('now-playing-title').innerText = episodes[current].title;
            document.querySelectorAll('.list-item-ep').forEach(el => el.classList.remove('current'));
            document.getElementById(`ep-${current}`)?.classList.add('current');
            audio.play();
            updateMediaSession(episodes[current].title);
            
            // On pr√©-charge d√©j√† le suivant (celui d'apr√®s encore)
            if (current + 1 < episodes.length) {
                callApi(`action=getAudio&guid=${episodes[current+1].guid}`).then(url => {
                    nextUrlCache = url;
                });
            }
        } else {
            // Si le cache n'√©tait pas pr√™t, m√©thode normale
            play(current + 1);
        }
    }
};

loadPlaylists();
</script>
</body>
</html>
