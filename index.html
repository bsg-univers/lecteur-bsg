<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="icon" type="image/png" href="https://baleinesousgravillon.com/wp-content/uploads/2022/02/cropped-Baleine_sous_gravillon-1-270x270.png">
    <link rel="apple-touch-icon" href="https://baleinesousgravillon.com/wp-content/uploads/2022/02/cropped-Baleine_sous_gravillon-1-270x270.png">

    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0b0e14">
    <title>Baleine sous gravillon ‚Äì Les podcasts</title>
    <meta name="title" content="Baleine sous gravillon ‚Äî Les podcasts du Vivant">
    <meta name="description" content="Plongez dans les profondeurs du vivant avec notre lecteur de playlists d√©di√©.">

    <meta property="og:type" content="website">
    <meta property="og:url" content="https://bsg-univers.github.io/bsg-player/">
    <meta property="og:title" content="Baleine sous gravillon ‚Äî Les podcasts du Vivant">
    <meta property="og:description" content="√âcoutez nos √©pisodes et playlists th√©matiques. Une immersion sonore unique.">
    <meta property="og:image" content="https://baleinesousgravillon.com/wp-content/uploads/2022/05/Banniere_fb_orditel_FG_8-scaled.jpg">

    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:title" content="Baleine sous gravillon ‚Äî Les podcasts">
    <meta property="twitter:description" content="Plongez dans les profondeurs du Vivant.">
    <meta property="twitter:image" content="https://baleinesousgravillon.com/wp-content/uploads/2022/05/Banniere_fb_orditel_FG_8-scaled.jpg">

    <style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

:root{
  --primary:#f3c300;

  --black-void:#050608;
  --blue-abyss:#031b28;
  --green-abyss:#04251e;

  --glass-soft:rgba(255,255,255,0.04);
  --glass-strong:rgba(255,255,255,0.08);
}

body::before{
  content:"";
  position:fixed;
  top:-1px;  /* D√©calage anti-aliasing */
  left:-1px; /* D√©calage anti-aliasing */
  right:0;
  bottom:0;
  pointer-events:none;
  z-index:-1;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.035'/%3E%3C/svg%3E");
}


/* ===================== */
/*      FOND GLOBAL      */
/* ===================== */

html, body{
  min-height:100%;
}

body{
  font-family:'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
  font-size:1.1rem;
  color:#eaeaea;
  margin:0;
  padding-bottom:160px;

  min-height:100vh;

  background-color:#0b0e14;
  background-image:
    radial-gradient(circle at 20% 30%, rgba(70,130,180,0.28) 0%, transparent 60%),
    radial-gradient(circle at 80% 70%, rgba(0,120,90,0.18) 0%, transparent 65%),
    radial-gradient(circle at 50% 50%, rgba(0,40,60,0.22) 0%, transparent 70%);

  background-repeat:no-repeat;
  background-size:cover;
  background-position:center center;
}

/* ===================== */
/*        HEADER         */
/* ===================== */
/* R√©initialisation globale */

header {
  position: relative; /* Priorit√© d'affichage */
  z-index: 10;        /* Priorit√© d'affichage */
  width: 100%;
  text-align: center;
  padding: 32px 20px;
  background: linear-gradient(to bottom, 
    rgba(0,0,0,0.85) 0%, 
    rgba(0,0,0,0.85) 5%, 
    rgba(0,0,0,0.55) 90%);
  box-shadow: 0 5px 90px rgba(0,0,0,0.8);
}

.logo-main{
  max-width:200px;
  margin-bottom:16px;
  filter:
    drop-shadow(0 0 14px rgba(243,195,0,0.25))
    drop-shadow(0 0 40px rgba(243,195,0,0.08));
}

/* lien image */
.site-image-link{
  display:inline-block;
  margin-right:7px;
  width:58px;
  height:58px;
  border-radius:5px;
  overflow:hidden;
  background:#000;
  box-shadow:
    0 0 0 1px rgba(243,195,0,0.15),
    0 15px 35px rgba(0,0,0,0.8);
  transition:transform .35s ease, box-shadow .35s ease;
}

.site-image-link:hover{
  transform:translateY(-4px) scale(1.06);
  box-shadow:
    0 0 0 1px rgba(243,195,0,0.35),
    0 20px 45px rgba(0,0,0,0.9);
}

.site-image-link img{
  width:100%;
  height:100%;
  object-fit:cover;
}

/* ===================== */
/*       CONTENU         */
/* ===================== */
.container{
  max-width:820px;
  margin:auto;
  padding:28px 20px;
}

h2,h3{
  color:var(--primary);
  font-size:1rem;
  letter-spacing:1px;
  text-transform:uppercase;
  margin:32px 0 18px;
  padding-left:14px;
  border-left:3px solid var(--primary);
  text-shadow:0 0 10px rgba(243,195,0,0.15);
}

/* ===================== */
/* SAISONS RELOADED    */
/* ===================== */
.grid-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
  gap: 20px;
  perspective: 1000px; /* Pour un effet de profondeur */
}

.season-item {
  position: relative;
  padding: 20px 15px;
  font-weight: 700;
  font-size: 0.95rem;
  color: rgba(255,255,255,0.9);
  text-align: center;
  cursor: pointer;
  z-index: 1;
  overflow: hidden;

    /* Supprime le rectangle bleu sur mobile */
  -webkit-tap-highlight-color: transparent;
  
  /* Supprime le contour de s√©lection au focus (clavier/accessibilit√©) */
  outline: none;
    
  /* Forme "Galet" irr√©guli√®re */
  border-radius: 60% 40% 70% 30% / 40% 50% 60% 40%;
  
  /* Look Abyss Glass */
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(243, 195, 0, 0.2);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  
  /* Ombre douce et lueur interne */
  box-shadow: 
    0 10px 20px rgba(0,0,0,0.3),
    inset 0 0 15px rgba(243, 195, 0, 0.05);

  /* Animation de flottaison */
  animation: float 6s ease-in-out infinite;
  transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

/* On d√©cale l'animation pour chaque bouton pour un effet naturel */
.season-item:nth-child(even) {
  animation-duration: 7s;
  border-radius: 40% 60% 35% 65% / 50% 40% 60% 50%;
}

@keyframes float {
  0%, 100% { transform: translateY(0px) rotate(0deg); }
  50% { transform: translateY(-10px) rotate(2deg); }
}

.season-item:hover {
  background: var(--primary);
  color: #0b0e14;
  transform: scale(1.1) rotate(-2deg);
  border-color: var(--primary);
  box-shadow: 0 15px 30px rgba(243, 195, 0, 0.3);
  animation-play-state: paused; /* S'arr√™te quand on le survole */
}

.season-item:hover::after {
  left: 120%;
}

.season-item:active {
  transform: scale(0.95);
}

/* ===================== */
/*      √âPISODES         */
/* ===================== */
.episode-item{
  margin-bottom:10px;
  padding:16px 20px;
  border-radius:16px;

  display:flex;
  align-items:center;
  justify-content:space-between;

  cursor:pointer;
  border-left:0 solid var(--primary);
  transition:all .25s ease;
        /* Supprime le rectangle bleu sur mobile */
  -webkit-tap-highlight-color: transparent;
  
  /* Supprime le contour de s√©lection au focus (clavier/accessibilit√©) */
  outline: none;
}

.episode-item:hover{
  background:
    linear-gradient(160deg,
      rgba(255,255,255,0.08),
      rgba(255,255,255,0.02));
}

.episode-item.current{
  border-left:6px solid var(--primary);

  box-shadow:
    0 5px 15px rgba(0,0,0,0.35);
}

.episode-title{
  flex-grow:1;
  margin-right:14px;
  font-size:1rem;;
}

/* bouton partage */
/* bouton partage */
.btn-share {
  flex-shrink: 0; /* Empeche le cercle de s'√©craser */
  background: transparent;
  border: 1px solid rgba(243,195,0,0.6);
  color: var(--primary);
  width: 34px;
  height: 34px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all .3s ease;
  animation: pulse-border 12s infinite ease-in-out;
      /* Supprime le rectangle bleu sur mobile */
  -webkit-tap-highlight-color: transparent;
  
  /* Supprime le contour de s√©lection au focus (clavier/accessibilit√©) */
  outline: none;
}

@keyframes pulse-border {
  0%, 100% { border-color: rgba(243, 195, 0, 0.3); box-shadow: 0 8px 20px rgba(0,0,0,0.6); }
  50% { border-color: rgba(243, 195, 0, 0.8); box-shadow: 0 0 15px rgba(243, 195, 0, 0.4); }
}

.btn-share:hover{
  background:var(--primary);
  color:#111;
}

/* ===================== */
/* PLAYER UNIFI√â      */
/* ===================== */
.player-container {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;

    /* Effet Abyss Glass coh√©rent */
    background: rgba(11, 14, 20, 0.95);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);

    /* Forme "Galet" uniquement sur le haut pour rester coll√© en bas */
    /* On cr√©e une ondulation organique sur la bordure sup√©rieure */
    border-radius: 70px 70px 0 0 / 25px 25px 0 0;
    
    padding: 20px 30px 25px;
    
    /* Bordure dor√©e fine comme les boutons */
    border-top: 1px solid rgba(243, 195, 0, 0.3);
    
    /* Lueur interne et ombre profonde */
    box-shadow: 
        0 -15px 40px rgba(0,0,0,0.8),
        inset 0 2px 15px rgba(243, 195, 0, 0.1);
    
    z-index: 1000;
    
    /* Animation tr√®s subtile pour rappeler la flottaison des boutons */
    animation: playerSubtleWave 10s ease-in-out infinite;
}

@keyframes playerSubtleWave {
    0%, 100% { border-top-color: rgba(243, 195, 0, 0.3); }
    50% { border-top-color: rgba(243, 195, 0, 0.6); }
}

.now-playing {
    text-align: center;
    font-size: 0.9rem;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 14px;
    text-shadow: 0 0 15px rgba(243, 195, 0, 0.4);
    /* Pour √©viter que le titre ne casse la forme */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

audio {
    width: 100%;
    height: 40px;
    border-radius: 50px; /* Style pilule pour le lecteur */
    /* Filtre pour rendre le lecteur natif plus √©l√©gant sur fond noir */
    filter: invert(100%) hue-rotate(180deg) brightness(1.5) contrast(0.8);
    opacity: 0.9;
}

/* ===================== */
/*       TOAST           */
/* ===================== */
#toast{
  opacity:0;
  pointer-events:none;

  min-width:200px;
  background:var(--primary);
  color:#111;
  text-align:center;
  border-radius:30px;
  padding:12px 18px;

  position:fixed;
  left:50%;
  bottom:120px;
  transform:translate(-50%, 12px);

  font-weight:700;
  font-size:.8em;

  box-shadow:0 10px 30px rgba(0,0,0,0.8);

  transition:
    opacity .35s ease,
    transform .35s ease;
}

#toast.show{
  opacity:1;
  transform:translate(-50%, 0);
}


.loader{
  text-align:center;
  color:var(--primary);
  padding:24px;
  font-style:italic;
}
</style>
</head>
<body>

<header>
<a href="https://baleinesousgravillon.com/" target="_blank" title="Aller sur le site officiel">
    <img src="https://baleinesousgravillon.com/wp-content/uploads/2023/08/logo-accueil3Plan-de-travail-2-copie-3@2x-1.png" alt="Logo" class="logo-main"><br>
</a>
<a href="https://baleinesousgravillon.com/" target="_blank" class="site-image-link" title="Aller sur le site officiel">
    <img src="https://image.ausha.co/CQMRa8hZ950ZAamQlgLxjsA38VuxGAXyvYCZXFXK_400x400.jpeg" alt="Lien Site">
</a>
<a href="https://baleinesousgravillon.com/" target="_blank" class="site-image-link" title="Aller sur le site officiel">
    <img src="https://image.ausha.co/A7P2IR07j1IuiB6cAAY9LjKIEcrbr4dPsgqobQHP_400x400.jpeg" alt="Lien Site">
</a>
<a href="https://baleinesousgravillon.com/" target="_blank" class="site-image-link" title="Aller sur le site officiel">
    <img src="https://image.ausha.co/CBnPjfz7mxzBMJg4Fc3OGIHETweeY5jv4GH5JdU0_400x400.jpeg" alt="Lien Site">
</a>
<a href="https://baleinesousgravillon.com/" target="_blank" class="site-image-link" title="Aller sur le site officiel">
    <img src="https://image.ausha.co/0xC11gNAqCw0Flp5qCUhuWM9kJI3p8Lw6J3lLm5w_400x400.jpeg" alt="Lien Site">
</a>
</header>

<div class="container">
    <div id="seasons_grid" class="grid-list"></div>
    <div id="episodes_list"></div>
</div>

<div class="player-container">
    <div id="now-playing-title" class="now-playing">S√©lectionnez une aventure...</div>
    <audio id="player" style="border-radius: 15px;" controls playsinline preload="auto"></audio>
</div>

<script>
// --- CONFIGURATION ---
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwm-8iBh2aMDepvxSHpl0ywwlZpWIaEEh7veSNYyEG-X0gSalh6--vbhxyV4PR2GXMjvQ/exec";
let episodes = [];
let current = 0;
let allPlaylists = [];

const audio = document.getElementById('player');
const titleDisplay = document.getElementById('now-playing-title');

// --- MEDIA SESSION : handlers d√©clar√©s UNE SEULE FOIS ---
if ('mediaSession' in navigator) {
    navigator.mediaSession.setActionHandler('play', () => audio.play());
    navigator.mediaSession.setActionHandler('pause', () => audio.pause());
    navigator.mediaSession.setActionHandler('previoustrack', () => {
        if (current > 0) play(current - 1);
    });
    navigator.mediaSession.setActionHandler('nexttrack', () => {
        if (current + 1 < episodes.length) play(current + 1);
    });
    navigator.mediaSession.setActionHandler('seekbackward', (d) => {
        audio.currentTime -= (d.seekOffset || 10);
    });
    navigator.mediaSession.setActionHandler('seekforward', (d) => {
        audio.currentTime += (d.seekOffset || 10);
    });
}

// --- API ---
async function callApi(params) {
    const response = await fetch(`${SCRIPT_URL}?${params}`);
    return await response.json();
}

// --- PLAYLISTS ---
async function loadPlaylists() {
    const urlParams = new URLSearchParams(window.location.search);
    const initialPlaylistId = urlParams.get('playlistId')
        ? decodeURIComponent(urlParams.get('playlistId').replace(/\+/g, ' '))
        : null;

    allPlaylists = (await callApi("action=getPlaylists")).filter(p => p.public);

    const seasons = [...new Set(allPlaylists.map(p => p.season))].sort().reverse();
    const grid = document.getElementById('seasons_grid');

    grid.innerHTML = seasons.map(s =>
        `<div class="season-item" onclick="showPlaylistsBySeason('${s}')">${s}</div>`
    ).join('');

    if (initialPlaylistId) {
        const shared = allPlaylists.find(p => String(p.id).trim() === initialPlaylistId.trim());
        if (shared) {
            showPlaylistsBySeason(shared.season);
            loadEpisodes(shared.id);
            return;
        }
    }

    showPlaylistsBySeason(seasons[0]);
}

function showPlaylistsBySeason(season) {
    document.querySelectorAll('.season-item').forEach(btn => {
        const active = btn.innerText === season;
        btn.style.borderColor = active ? "var(--primary)" : "rgba(243,195,0,0.2)";
        btn.style.background = active ? "rgba(243,195,0,0.15)" : "rgba(255,255,255,0.03)";
    });

    const list = allPlaylists.filter(p => p.season === season);
    const div = document.getElementById('episodes_list');

    div.innerHTML = `<h2>Playlists ‚Äî ${season}</h2>` + list.map(p => {
        const encoded = btoa(unescape(encodeURIComponent(p.id)));
        return `
        <div class="episode-item" onclick="loadEpisodes('${encoded}', true)">
            <span class="episode-title"><strong>${p.name}</strong></span>
            <button class="btn-share" onclick="sharePlaylist(event, '${encoded}')">üîó</button>
        </div>`;
    }).join('');
}

// --- PARTAGE ---
function sharePlaylist(e, encodedPid) {
    e.stopPropagation();
    const pid = decodeURIComponent(escape(atob(encodedPid)));
    const url = new URL(location.origin + location.pathname);
    url.searchParams.set('playlistId', pid);
    navigator.clipboard.writeText(url.toString()).then(showToast);
}

function showToast() {
    const toast = document.getElementById("toast");
    toast.className = "show";
    setTimeout(() => toast.className = "", 3000);
}

// --- √âPISODES ---
async function loadEpisodes(pid, encoded = false) {
    const cleanId = encoded ? decodeURIComponent(escape(atob(pid))) : pid;
    const div = document.getElementById('episodes_list');

    div.innerHTML = '<div class="loader">Plong√©e...</div>';
    episodes = await callApi(`action=getEpisodes&playlistId=${encodeURIComponent(cleanId)}`);

    if (!episodes || !episodes.length) {
        div.innerHTML = '<p>Aucun √©pisode trouv√©.</p>';
        return;
    }

    div.innerHTML = `<h3>√âpisodes</h3>` + episodes.map((e, i) => `
        <div class="episode-item list-item-ep" id="ep-${i}" onclick="play(${i})">
            <span class="episode-title">${e.title}</span>
            <span style="color:var(--primary); font-size:0.8em;">‚ñ∂</span>
        </div>
    `).join('');

    play(0);
}

// --- LECTURE OPTIMIS√âE ---
async function play(i) {
    current = i;

    // 1. UI Update imm√©diate
    document.querySelectorAll('.list-item-ep').forEach(el => el.classList.remove('current'));
    document.getElementById(`ep-${i}`)?.classList.add('current');
    titleDisplay.innerText = "Plong√©e en cours...";

    try {
        // 2. R√©cup√©rer l'URL
        const audioUrl = await callApi(`action=getAudio&guid=${episodes[i].guid}`);
        if (!audioUrl) return;

        // 3. Charger et pr√©parer la session
        audio.src = audioUrl;
        audio.load(); // Force le chargement
        
        updateMediaSession(episodes[i].title);

        // 4. Lancer la lecture
        // On utilise un bloc .play() propre
        const playPromise = audio.play();
        
        if (playPromise !== undefined) {
            playPromise.then(() => {
                titleDisplay.innerText = episodes[i].title;
            }).catch(error => {
                console.log("Lecture bloqu√©e :", error);
                // Si bloqu√©, on affiche un bouton "Play" g√©ant ou un message
                titleDisplay.innerText = "Cliquez sur Play pour continuer";
            });
        }
    } catch (err) {
        console.error("Erreur API :", err);
    }
}

// --- MEDIA SESSION METADATA ---
function updateMediaSession(title) {
    if (!('mediaSession' in navigator)) return;

    navigator.mediaSession.metadata = new MediaMetadata({
        title,
        artist: "Baleine sous gravillon",
        album: "Le podcast du Vivant",
        artwork: [
            { src: 'https://baleinesousgravillon.com/wp-content/uploads/2022/02/cropped-Baleine_sous_gravillon-1-270x270.png', sizes: '270x270', type: 'image/png' },
            { src: 'https://image.ausha.co/CQMRa8hZ950ZAamQlgLxjsA38VuxGAXyvYCZXFXK_400x400.jpeg', sizes: '400x400', type: 'image/jpeg' }
        ]
    });
}

// --- GESTION DU WAKE LOCK (Emp√™cher la mise en veille profonde) ---
let wakeLock = null;
async function requestWakeLock() {
    try {
        if ('wakeLock' in navigator) {
            wakeLock = await navigator.wakeLock.request('screen');
        }
    } catch (err) {
        console.log("WakeLock non support√© ou refus√©");
    }
}
    
// --- √âV√âNEMENTS AUDIO ---
audio.addEventListener('play', () => {
    if ('mediaSession' in navigator) navigator.mediaSession.playbackState = "playing";
});

audio.addEventListener('pause', () => {
    if ('mediaSession' in navigator) navigator.mediaSession.playbackState = "paused";
});

// --- MODIFICATION DE L'√âV√âNEMENT ENDED ---
audio.addEventListener('ended', async () => {
    if (current + 1 < episodes.length) {
        // Petit d√©lai pour laisser le syst√®me respirer
        setTimeout(() => {
            play(current + 1);
        }, 500);
    }
});

// Relancer le WakeLock quand on reprend la lecture
audio.addEventListener('play', () => {
    requestWakeLock();
    if ('mediaSession' in navigator) navigator.mediaSession.playbackState = "playing";
});
    
// --- INIT ---
loadPlaylists();

if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').catch(err => console.log("Erreur SW", err));
}
</script>

    <div id="toast">Lien copi√© !</div>
</body>
</html>
