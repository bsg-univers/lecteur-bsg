<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="icon" type="image/png" href="https://baleinesousgravillon.com/wp-content/uploads/2022/02/cropped-Baleine_sous_gravillon-1-270x270.png">
    <link rel="apple-touch-icon" href="https://baleinesousgravillon.com/wp-content/uploads/2022/02/cropped-Baleine_sous_gravillon-1-270x270.png">

    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0b0e14">
    <title>Baleine sous gravillon ‚Äì Les podcasts</title>
    <meta name="title" content="Baleine sous gravillon ‚Äî Les podcasts du Vivant">
    <meta name="description" content="Plongez dans les profondeurs du vivant avec notre lecteur de playlists d√©di√©.">

    <meta property="og:type" content="website">
    <meta property="og:url" content="https://bsg-univers.github.io/bsg-player/">
    <meta property="og:title" content="Baleine sous gravillon ‚Äî Les podcasts du Vivant">
    <meta property="og:description" content="√âcoutez nos √©pisodes et playlists th√©matiques. Une immersion sonore unique.">
    <meta property="og:image" content="https://baleinesousgravillon.com/wp-content/uploads/2022/05/Banniere_fb_orditel_FG_8-scaled.jpg">

    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:title" content="Baleine sous gravillon ‚Äî Les podcasts">
    <meta property="twitter:description" content="Plongez dans les profondeurs du Vivant.">
    <meta property="twitter:image" content="https://baleinesousgravillon.com/wp-content/uploads/2022/05/Banniere_fb_orditel_FG_8-scaled.jpg">

    <style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  text-rendering: optimizeLegibility;
}

:root{
  --primary:#d2b347;

  --black-void:#050608;
  --blue-abyss:#031b28;
  --green-abyss:#04251e;

  --glass-soft:rgba(255,255,255,0.04);
  --glass-strong:rgba(255,255,255,0.08);
}

body::before{
  content:"";
  position:fixed;
  left:-1px; /* D√©calage anti-aliasing */
  right:0;
  bottom:0;
  pointer-events:none;
  z-index:-1;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.035'/%3E%3C/svg%3E");
}

        
/* ===================== */
/*      FOND GLOBAL      */
/* ===================== */

html, body{
  min-height:100%;
}
        
html {
  scroll-behavior: smooth;
  /* Emp√™che les rebonds √©lastiques excessifs sur iOS */
  overscroll-behavior-y: auto; 
}
        
body{
  font-family:'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
  font-size:1.1rem;
  color: rgba(234, 234, 234, 0.85);
  margin:0;
  padding-bottom:160px;

  min-height:100vh;

  background-color:#0b0e14;
  background-image:
    radial-gradient(circle at 20% 30%, rgba(70,130,180,0.28) 0%, transparent 60%),
    radial-gradient(circle at 80% 70%, rgba(0,120,90,0.18) 0%, transparent 65%),
    radial-gradient(circle at 50% 50%, rgba(0,40,60,0.22) 0%, transparent 70%);

  background-repeat:no-repeat;
  background-size:cover;
  background-position:center center;
  -webkit-overflow-scrolling: touch; /* Force le scroll "inertiel" sur vieux iOS */
  overflow-x: hidden; /* √âvite les glissements lat√©raux parasites */
}

/* ===================== */
/*        HEADER         */
/* ===================== */
header {
    text-align: center;
    padding: 10px 20px 10px;
    background: transparent;
    margin-top: 0;
}

.logo-main {
    max-width: 140px;
    height: auto;
    display: block; /* √âvite les d√©calages de texte */
    transition: transform 0.3s ease;
}

/* Le dock par d√©faut (quand on choisit une saison) */
.nav-dock {
    position: sticky;
    top: 10px;
    z-index: 3000;
    width: fit-content; 
    margin: 0 auto 20px auto;
    display: flex;
    gap: 12px;
    padding: 10px 14px;
    background: rgba(15, 18, 25, 0.98);
    border-radius: 22px;
    border: 1px solid rgba(234, 189, 6, 0.4);
    box-shadow: 0 12px 25px rgba(0, 0, 0, 0.6);
    transition: all 0.4s ease;
}

/* LA CLASSE MAGIQUE : Le dock redevient normal et reste en haut de la page */
.nav-dock.is-static {
    position: relative !important; /* Il ne colle plus au haut de l'√©cran */
    top: 0 !important;
    box-shadow: none; /* On peut r√©duire l'ombre pour plus de discr√©tion */
    margin-bottom: 30px;
}

 .nav-dock.hidden {
    opacity: 0;
    visibility: hidden;
    transform: translateY(-20px); /* Petit effet de remont√©e en disparaissant */
    pointer-events: none; /* Emp√™che de cliquer dessus quand il est invisible */
}
        
.site-image-link {
    width: 60px;
    height: 60px;
    border-radius: 10px;
    overflow: hidden;
    flex-shrink: 0;
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: transform 0.2s ease;
}

.site-image-link:active {
    transform: scale(0.9);
}

.site-image-link img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* ===================== */
/*       CONTENU         */
/* ===================== */
.container{
  max-width:820px;
  margin:auto;
  padding:28px 20px;
}

h2,h3{
  color:var(--primary);
  font-size:1rem;
  letter-spacing:1px;
  text-transform:uppercase;
  margin:32px 0 18px;
  padding-left:14px;
  border-left:3px solid var(--primary);
  text-shadow:0 0 10px rgba(243,195,0,0.15);
}

/* ===================== */
/* SAISONS ZEN - COMPACT */
/* ===================== */

.grid-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
  gap: 20px;
  perspective: 1000px; /* Pour un effet de profondeur */
}

.season-item {
  position: relative;
  padding: 20px 15px;
  font-weight: 700;
  font-size: 0.95rem;
  font-size: 0.85rem; /* Texte l√©g√®rement plus petit */
  color: rgba(255, 255, 255, 0.9);
  text-align: center;
  cursor: pointer;
  z-index: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 60px; /* Assure une forme harmonieuse */

  -webkit-tap-highlight-color: transparent;
  outline: none;

  /* Look Verre Poli */
  background: rgba(40, 45, 55, 0.8); 
  border: 1px solid rgba(255, 255, 255, 0.1);
  will-change: transform;

  /* Ombre tr√®s douce pour √©viter l'aspect lourd */
  box-shadow: 
    0 8px 15px rgba(0, 0, 0, 0.2),
    inset 0 0 10px rgba(255, 255, 255, 0.05);

  transition: all 0.3s ease-in-out;
  animation: float-organic 7s ease-in-out infinite;
}

/* --- Formes de galets plus subtiles pour petits formats --- */
.season-item:nth-child(4n+1) { 
  border-radius: 55% 45% 65% 35% / 45% 40% 60% 55%; 
  animation-delay: 0s;
}
.season-item:nth-child(4n+2) { 
  border-radius: 45% 55% 45% 55% / 50% 55% 45% 50%; 
  animation-delay: -1.5s;
  animation-duration: 8s;
}
.season-item:nth-child(4n+3) { 
  border-radius: 60% 40% 50% 50% / 40% 45% 55% 60%; 
  animation-delay: -3s;
}
.season-item:nth-child(4n+4) { 
  border-radius: 45% 50% 40% 60% / 55% 45% 55% 45%; 
  animation-delay: -4.5s;
  animation-duration: 9s;
}

/* --- Animation plus calme --- */
@keyframes float-organic {
  0%, 100% { transform: translate(0, 0) rotate(0deg); }
  50% { transform: translate(2px, -6px) rotate(1deg); }
}

/* --- Hover & Active --- */
.season-item:hover {
  background: rgba(255, 255, 255, 0.15);
  transform: translateY(-3px) scale(1.03);
  box-shadow: 0 12px 20px rgba(0, 0, 0, 0.25);
}

.season-item.active,
.season-item[style*="border-color: var(--primary)"] {
  background: var(--primary);
  color: #0b0e14;
  border-color: transparent;
  animation: none !important;
  transform: scale(1) !important;
  box-shadow: 0 10px 20px rgba(243, 195, 0, 0.3);
}


/* ===================== */
/*      √âPISODES         */
/* ===================== */

#player-img {
    position: fixed;
    left: 50%;
    transform: translate(-50%, 0);
    z-index: 2000;
    
    border-radius: 12px;
    object-fit: cover;
    background: #0b0e14;
    border: 1px solid rgba(243, 195, 0, 0.4);
    
    /* Animation fluide entre petit et grand */
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

/* √âTAT LOGO (Petit) */
#player-img.is-logo {
    width: 60px; /* Taille miniature */
    bottom: 107px;
    height: 60px;
    border-radius: 50%; /* On peut m√™me le mettre en rond */
    cursor: default;
    box-shadow: 0 4px 15px rgba(0,0,0,0.4);
}

/* √âTAT √âPISODE (Grand) */
#player-img.is-episode {
    bottom: 112px;
    width: 140px;
    height: 140px;
    border-radius: 12px;
    cursor: zoom-in;
    box-shadow: 0 8px 25px rgba(0,0,0,0.6);
}

/* ZOOM UNIQUE ET PROPRE */
#player-img.zoomed {
    position: fixed !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) scale(2.3) !important; /* Centr√© parfaitement */
    z-index: 10000 !important;
    box-shadow: 0 0 0 100vmax rgba(0, 0, 0, 0.9) !important;
    border-radius: 15px;
    cursor: zoom-out;
}


/* Sur les √©crans plus larges (Ordinateur) */
@media (min-width: 768px) {
    #player-img.zoomed {
        transform: translate(-50%, calc(-50vh + 150px)) scale(3) !important;
    }
}

/* Animation d'ouverture */
@keyframes zoomIn {
    from { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
    to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
}
        
/* Conteneur sp√©cial pour le titre H2 et son bouton de partage */
.playlist-header-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin: 32px 0 18px;
    padding-left: 14px;
    border-left: 3px solid var(--primary);
}

/* On r√©initialise les marges du H2 car le conteneur g√®re l'espacement maintenant */
.playlist-header-container h2 {
    margin: 0;
    padding-left: 0;
    border-left: none;
    flex: 1;
}

/* Style sp√©cifique pour le bouton de partage en haut de page */
.playlist-header-container .btn-share {
    margin-left: 15px;
}
        
/* Style des liens dans la description */
.playlist-description-content a {
    color: var(--primary); /* Utilise ton jaune dor√© */
    text-decoration: underline;
    text-underline-offset: 3px;
    transition: opacity 0.2s;
}

.playlist-description-content a:hover {
    opacity: 0.8;
    text-decoration: none;
}

/* Optionnel : Si tu pr√©f√®res un bleu tr√®s doux √† la place du jaune */
        
/* --- Bloc Description Ultra-L√©ger --- */
.playlist-description-container {
    margin: 20px 0;
    padding: 18px 20px;
    border-radius: 16px;
    cursor: pointer;
    overflow: hidden;
    position: relative;
    height: 130px;
    transition: all 0.5s ease;
    /* Supprime le rectangle bleu au clic sur mobile (Chrome/Safari/Android) */
    -webkit-tap-highlight-color: transparent;
    
    /* Supprime la bordure de s√©lection (focus) sur certains navigateurs */
    outline: none;
    
    /* Emp√™che la s√©lection accidentelle du texte pendant le clic */
    -webkit-user-select: none;
    user-select: none;

    /* On enl√®ve tout fond sombre */
    background: rgba(255, 255, 255, 0.03);
    border: none !important;

    /* LA SOLUTION : Un masque de transparence au lieu d'une couleur noire */
    -webkit-mask-image: linear-gradient(to bottom, black 60%, transparent 100%);
    mask-image: linear-gradient(to bottom, black 60%, transparent 100%);
}

.playlist-description-container.expanded {
    height: auto;
    min-height: 130px;
    /* On retire le masque quand c'est ouvert pour tout voir */
    -webkit-mask-image: none;
    mask-image: none;
    background: rgba(255, 255, 255, 0.06);
}

.playlist-description-content {
    font-size: 0.92rem;
    line-height: 1.5;
    /* On rend le texte un peu plus gris/transparent pour moins trancher */
    color: rgba(234, 234, 234, 0.6); 
}

.read-more-hint {
    color: var(--primary); 
    font-size: 0.65rem; 
    font-weight: bold;
    text-transform: uppercase; 
    margin-top: 8px; 
    display: none; 
    letter-spacing: 1.2px;
    opacity: 0.8;
}
        
/* ===================== */
/*      √âPISODES         */
/* ===================== */
.episode-item{
  margin-bottom:10px;
  padding:16px 20px;
  border-radius:16px;

  display:flex;
  align-items:center;
  justify-content:space-between;

  cursor:pointer;
  border-left:0 solid var(--primary);
  transition:all .25s ease;
        /* Supprime le rectangle bleu sur mobile */
  -webkit-tap-highlight-color: transparent;
  
  /* Supprime le contour de s√©lection au focus (clavier/accessibilit√©) */
  outline: none;
}

.episode-item:hover{
  background:
    linear-gradient(160deg,
      rgba(255,255,255,0.08),
      rgba(255,255,255,0.02));
}

.episode-item.current{
  border-left:6px solid var(--primary);

  box-shadow:
    0 5px 15px rgba(0,0,0,0.35);
}

.episode-title {
  flex: 1;              /* Prend l'espace disponible */
  margin-right: 20px;   /* Espace minimal entre la fin du texte et le bouton */
  font-size: 1rem;
  text-align: left;
  
  /* Permet au texte de passer √† la ligne suivante */
  white-space: normal;  
  word-wrap: break-word; 
  line-height: 1.4;
}

/* bouton partage */
.btn-share {
  flex-shrink: 0;       /* EMP√äCHE le bouton de s'√©craser si le titre est long */
  background: transparent;
  border: 1px solid rgba(243,195,0,0.6);
  color: var(--primary);
  width: 34px;
  height: 34px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all .3s ease;
  animation: pulse-border 12s infinite ease-in-out;
      /* Supprime le rectangle bleu sur mobile */
  -webkit-tap-highlight-color: transparent;
  
  /* Supprime le contour de s√©lection au focus (clavier/accessibilit√©) */
  outline: none;
}

@keyframes pulse-border {
  0%, 100% { border-color: rgba(243, 195, 0, 0.3); box-shadow: 0 8px 20px rgba(0,0,0,0.6); }
  50% { border-color: rgba(243, 195, 0, 0.8); box-shadow: 0 0 15px rgba(243, 195, 0, 0.4); }
}

.btn-share:hover{
  background:var(--primary);
  color:#111;
}

/* --- LE CONTENEUR (Ligne courbe) --- */
.player-container {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    background: rgba(11, 14, 20, 0.98);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    
    border-radius: 60px 60px 0 0 / 25px 25px 0 0;
    border-top: 1px solid rgba(243, 195, 0, 0.3); /* Bordure l√©g√®rement plus √©paisse */
    
    padding: 0px 20px 20px; 
    box-shadow: 0 -15px 40px rgba(0,0,0,0.7);
    
    /* Animation un peu plus rapide (15s) et plus visible */
    animation: playerSubtleWave 15s ease-in-out infinite;
}

/* --- LE TITRE (Espace r√©tabli) --- */
.now-playing {
    text-align: center;
    font-size: 0.95rem;
    font-weight: 700;
    color: var(--primary);
    
    /* On augmente la marge pour d√©coller le texte de l'image et de la ligne */
    margin-top: 40px; 
    margin-bottom: 10px; 
    

    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* --- LE LECTEUR AUDIO (Espace avec le titre) --- */
audio {
    width: 100%;
    height: 40px;
    filter: invert(100%) hue-rotate(180deg) brightness(1.5) contrast(0.9);
    border-radius: 15px;
    margin-bottom: 2px; /* Petit espace en bas */
}

/* --- ANIMATIONS RENFORC√âES (Visibles) --- */
@keyframes borderPulse {
    0%, 100% { 
        border-color: rgba(243, 195, 0, 0.35); 
        box-shadow: 0 0 12px rgba(243, 195, 0, 0.08);
    }
    50% { 
        border-color: rgba(243, 195, 0, 0.55);
        box-shadow: 0 0 18px rgba(243, 195, 0, 0.18);
    }
}


@keyframes playerSubtleWave {
    0%, 100% { 
        border-top-color: rgba(243, 195, 0, 0.25); 
    }
    50% { 
        border-top-color: rgba(243, 195, 0, 0.45); 
    }
}

/* ===================== */
/*       TOAST           */
/* ===================== */
#toast {
  opacity: 0;
  pointer-events: none;

  min-width: 200px;
  background: var(--primary);
  color: #111;
  text-align: center;
  border-radius: 30px;
  padding: 12px 18px;

  position: fixed;
  left: 50%;
  /* MODIFICATION ICI : on le remonte pour passer au-dessus de l'image */
  bottom: 260px; 
  /* On augmente aussi le z-index pour √™tre s√ªr qu'il soit au premier plan */
  z-index: 2000; 

  transform: translate(-50%, 12px);
  font-weight: 700;
  font-size: .8em;
  box-shadow: 0 10px 30px rgba(0,0,0,0.8);
  transition: opacity .35s ease, transform .35s ease;
}

#toast.show{
  opacity:1;
  transform:translate(-50%, 0);
}


.loader{
  text-align:center;
  color:var(--primary);
  padding:24px;
  font-style:italic;
}
</style>
</head>
<body>

<nav class="nav-dock">
    <a href="https://baleinesousgravillon.com/" target="_blank" class="site-image-link" title="Baleine sous Gravillon">
        <img src="https://image.ausha.co/CQMRa8hZ950ZAamQlgLxjsA38VuxGAXyvYCZXFXK_400x400.jpeg" alt="BSG">
    </a>
    <a href="https://baleinesousgravillon.com/" target="_blank" class="site-image-link" title="Combats">
        <img src="https://image.ausha.co/A7P2IR07j1IuiB6cAAY9LjKIEcrbr4dPsgqobQHP_400x400.jpeg" alt="Combats">
    </a>
    <a href="https://baleinesousgravillon.com/" target="_blank" class="site-image-link" title="Petit Poisson">
        <img src="https://image.ausha.co/CBnPjfz7mxzBMJg4Fc3OGIHETweeY5jv4GH5JdU0_400x400.jpeg" alt="PPDV">
    </a>
    <a href="https://baleinesousgravillon.com/" target="_blank" class="site-image-link" title="Nomen">
        <img src="https://image.ausha.co/0xC11gNAqCw0Flp5qCUhuWM9kJI3p8Lw6J3lLm5w_400x400.jpeg" alt="Nomen">
    </a>
</nav>

<div class="container">
    <div id="seasons_grid" class="grid-list"></div>
    <div id="episodes_list"></div>
</div>
<img id="player-img" class="is-logo" src="https://baleinesousgravillon.com/wp-content/uploads/2022/02/cropped-Baleine_sous_gravillon-1-270x270.png" alt="Illustration"> 
<div class="player-container">
    <div id="now-playing-title" class="now-playing">S√©lectionnez une aventure...</div>
    <audio id="player" style="border-radius: 15px;" controls playsinline preload="auto"></audio>
</div>

<script>
    
// --- CONFIGURATION ---
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyoj1HRP-nYuZW5YHoaNXLw64iLvbcK9Q-Wxj5hN6CgPNqNt6vXlrV9qfqBcyBRzRiH0A/exec";
let episodes = [];
let current = 0;
let allPlaylists = [];

const audio = document.getElementById('player');
const titleDisplay = document.getElementById('now-playing-title');

// --- MEDIA SESSION : handlers d√©clar√©s UNE SEULE FOIS ---
if ('mediaSession' in navigator) {
    navigator.mediaSession.setActionHandler('play', () => audio.play());
    navigator.mediaSession.setActionHandler('pause', () => audio.pause());
    navigator.mediaSession.setActionHandler('previoustrack', () => {
        if (current > 0) play(current - 1);
    });
    navigator.mediaSession.setActionHandler('nexttrack', () => {
        if (current + 1 < episodes.length) play(current + 1);
    });
    navigator.mediaSession.setActionHandler('seekbackward', (d) => {
        audio.currentTime -= (d.seekOffset || 10);
    });
    navigator.mediaSession.setActionHandler('seekforward', (d) => {
        audio.currentTime += (d.seekOffset || 10);
    });
}

async function loadJSON(file) {
  const res = await fetch(`data/${file}`);
  return await res.json();
}


// --- PLAYLISTS ---
async function loadPlaylists() {
    const urlParams = new URLSearchParams(window.location.search);
    const initialPlaylistId = urlParams.get('playlistId')
        ? decodeURIComponent(urlParams.get('playlistId').replace(/\+/g, ' '))
        : null;

    allPlaylists = (await loadJSON("playlists.json")).filter(p => p.public);

    const seasons = [...new Set(allPlaylists.map(p => p.season))].sort().reverse();
    const grid = document.getElementById('seasons_grid');

    grid.innerHTML = seasons.map(s =>
        `<div class="season-item" onclick="showPlaylistsBySeason('${s}')">${s}</div>`
    ).join('');

    if (initialPlaylistId) {
        const shared = allPlaylists.find(p => String(p.id).trim() === initialPlaylistId.trim());
        if (shared) {
            showPlaylistsBySeason(shared.season);
            loadEpisodes(shared.id);
            return;
        }
    }

    showPlaylistsBySeason(seasons[0]);
}

 function resetPlayerImage() {
    const pImg = document.getElementById('player-img');
    if (pImg) {
        pImg.src = "https://baleinesousgravillon.com/wp-content/uploads/2022/02/cropped-Baleine_sous_gravillon-1-270x270.png";
        pImg.classList.remove('is-episode', 'zoomed');
        pImg.classList.add('is-logo');
    }
}

// Appelez cette fonction au chargement
window.addEventListener('DOMContentLoaded', resetPlayerImage);   

function showPlaylistsBySeason(season) {
    // Le dock redevient collant pour aider la navigation
    const dock = document.querySelector('.nav-dock');
    if (dock) dock.classList.remove('is-static');

    // ... votre code existant ...
    resetPlayerImage(); // On remet le petit logo
    titleDisplay.innerText = "S√©lectionnez une aventure...";

    
    document.querySelectorAll('.season-item').forEach(btn => {
        const active = btn.innerText === season;
        btn.style.borderColor = active ? "var(--primary)" : "rgba(243,195,0,0.2)";
        btn.style.background = active ? "rgba(243,195,0,0.15)" : "rgba(255,255,255,0.03)";
    });

    const list = allPlaylists.filter(p => p.season === season);
    const div = document.getElementById('episodes_list');

    div.innerHTML = `<h2>S√©ries ‚Äî ${season}</h2>` + list.map(p => {
        const encoded = btoa(unescape(encodeURIComponent(p.id)));
        return `
        <div class="episode-item" onclick="loadEpisodes('${encoded}', true)">
            <span class="episode-title"><strong>${p.name}</strong></span>
            <button class="btn-share" onclick="sharePlaylist(event, '${encoded}')">üîó</button>
        </div>`;
    }).join('');
}

// --- PARTAGE NATIF + COPIE ---
async function sharePlaylist(e, encodedPid) {
    e.stopPropagation();
    const pid = decodeURIComponent(escape(atob(encodedPid)));
    const url = new URL(location.origin + location.pathname);
    url.searchParams.set('playlistId', pid);
    const shareUrl = url.toString();

    // Donn√©es √† partager
    const shareData = {
        title: 'Baleine sous gravillon',
        text: `√âcoutez cette s√©rie : ${pid}`,
        url: shareUrl
    };

    try {
        // On v√©rifie si le navigateur supporte le partage natif (Mobile)
        if (navigator.share) {
            await navigator.share(shareData);
        } else {
            // Sinon (Ordinateur), on copie juste le lien
            await navigator.clipboard.writeText(shareUrl);
            showToast();
        }
    } catch (err) {
        // Si l'utilisateur annule le partage natif, on peut quand m√™me copier le lien en secours
        await navigator.clipboard.writeText(shareUrl);
        // On n'affiche le toast que si ce n'est pas une simple annulation
        if (err.name !== 'AbortError') {
            showToast();
        }
    }
}

function showToast() {
    const toast = document.getElementById("toast");
    toast.className = "show";
    setTimeout(() => toast.className = "", 3000);
}

// --- √âPISODES ---
async function loadEpisodes(pid, encoded = false) {
    // Le dock ne doit plus coller au scroll, il reste au sommet de la page
    const dock = document.querySelector('.nav-dock');
    if (dock) dock.classList.add('is-static');
    
    // D√©codage de l'ID si provenant d'un lien de partage
    const cleanId = encoded 
        ? decodeURIComponent(escape(atob(pid))) 
        : pid;

    const div = document.getElementById('episodes_list');
    div.innerHTML = '<div class="loader">Plong√©e...</div>';

    try {
        // 1. R√©cup√©rer la description de la playlist depuis la m√©moire
        // (allPlaylists a √©t√© rempli au chargement de la page via playlists.json)
        const currentPl = allPlaylists.find(p => String(p.id).trim() === cleanId.trim());
        const playlistDesc = currentPl ? currentPl.description : "";

        // 2. Charger les √©pisodes depuis le fichier JSON statique
        const res = await fetch('data/episodes.json');
        const allEpisodes = await res.json();

        // Filtrer et trier
        episodes = allEpisodes
            .filter(e => String(e.playlistId).trim() === cleanId.trim())
            .sort((a, b) => (a.order || 0) - (b.order || 0));

        if (!episodes.length) {
            div.innerHTML = '<p>Aucun √©pisode trouv√©.</p>';
            return;
        }

        // 3. Construction du HTML
        // On pr√©pare l'ID encod√© pour le bouton de partage
const headerEncoded = btoa(unescape(encodeURIComponent(cleanId)));

// On cr√©e une ligne avec le titre √† gauche et le bouton √† droite
let html = `
<div class="playlist-header-container">
    <h2>${cleanId}</h2>
    <button class="btn-share" onclick="sharePlaylist(event, '${headerEncoded}')" title="Partager cette s√©rie">üîó</button>
</div>`;

        // Affichage de la description avec l'effet "Lire la suite"
        if (playlistDesc && playlistDesc.trim() !== "") {
            html += `
            <div class="playlist-description-container" id="desc-container" onclick="this.classList.toggle('expanded')">
                <div class="playlist-description-content">
                    ${playlistDesc}
                </div>
                <span class="read-more-hint">Lire la suite...</span>
            </div>`;
        }

        // Liste des √©pisodes (votre code existant)
        html += `<h3>√âpisodes</h3>` +
            episodes.map((e, i) => `
                <div class="episode-item list-item-ep" id="ep-${i}" onclick="play(${i})">
                    <span class="episode-title">${e.title}</span>
                    <span style="color:var(--primary); font-size:0.8em;">‚ñ∂</span>
                </div>
            `).join('');

        div.innerHTML = html;
// --- AJOUT ICI : Correction des liens ---
        const descLinks = div.querySelectorAll('.playlist-description-content a');
        descLinks.forEach(link => {
            link.setAttribute('target', '_blank');
            link.setAttribute('rel', 'noopener noreferrer'); // S√©curit√©
        });        

        // Lecture auto du premier √©pisode
        play(0);

    } catch (err) {
        console.error('Erreur chargement episodes', err);
        div.innerHTML = '<p>Erreur de chargement des √©pisodes.</p>';
    }
}


async function play(i) {
    current = i;
    const episode = episodes[i];
    const pImg = document.getElementById('player-img');

    // 1. Gestion de l'image (Taille et Source)
    if (pImg) {
        pImg.classList.remove('zoomed');
        if (episode.image && episode.image.trim() !== "") {
            pImg.src = episode.image;
            pImg.classList.replace('is-logo', 'is-episode');
        } else {
            pImg.src = "https://baleinesousgravillon.com/wp-content/uploads/2022/02/cropped-Baleine_sous_gravillon-1-270x270.png";
            pImg.classList.replace('is-episode', 'is-logo');
        }
    }

    // 2. UI : S√©lection dans la liste
    document.querySelectorAll('.list-item-ep').forEach(el => el.classList.remove('current'));
    document.getElementById(`ep-${i}`)?.classList.add('current');

    // 3. Audio
    titleDisplay.innerText = "Plong√©e en cours...";
    audio.src = episode.audio;
    
    try {
        await audio.play();
        titleDisplay.innerText = episode.title;
        updateMediaSession(episode.title);
    } catch (err) {
        console.error("Erreur lecture", err);
        titleDisplay.innerText = "Cliquez sur ‚ñ∂ pour lire";
    }
}


// --- MEDIA SESSION METADATA ---
function updateMediaSession(title) {
    if (!('mediaSession' in navigator)) return;

    navigator.mediaSession.metadata = new MediaMetadata({
        title,
        artist: "Baleine sous gravillon",
        album: "Le podcast du Vivant",
        artwork: [
            { src: 'https://baleinesousgravillon.com/wp-content/uploads/2022/02/cropped-Baleine_sous_gravillon-1-270x270.png', sizes: '270x270', type: 'image/png' },
            { src: 'https://image.ausha.co/CQMRa8hZ950ZAamQlgLxjsA38VuxGAXyvYCZXFXK_400x400.jpeg', sizes: '400x400', type: 'image/jpeg' }
        ]
    });
}

// --- GESTION DU WAKE LOCK (Emp√™cher la mise en veille profonde) ---
let wakeLock = null;
async function requestWakeLock() {
    try {
        if ('wakeLock' in navigator) {
            wakeLock = await navigator.wakeLock.request('screen');
        }
    } catch (err) {
        console.log("WakeLock non support√© ou refus√©");
    }
}
    
// --- √âV√âNEMENTS AUDIO ---
audio.addEventListener('play', () => {
    if ('mediaSession' in navigator) navigator.mediaSession.playbackState = "playing";
});

audio.addEventListener('pause', () => {
    if ('mediaSession' in navigator) navigator.mediaSession.playbackState = "paused";
});

// --- MODIFICATION DE L'√âV√âNEMENT ENDED ---
audio.addEventListener('ended', async () => {
    if (current + 1 < episodes.length) {
        // Petit d√©lai pour laisser le syst√®me respirer
        setTimeout(() => {
            play(current + 1);
        }, 500);
    }
});

// Relancer le WakeLock quand on reprend la lecture
audio.addEventListener('play', () => {
    requestWakeLock();
    if ('mediaSession' in navigator) navigator.mediaSession.playbackState = "playing";
});
    
// --- INIT ---
loadPlaylists();

if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').catch(err => console.log("Erreur SW", err));
}
    
// Gestion du zoom robuste
document.addEventListener('click', function(e) {
    const pImg = document.getElementById('player-img');
    // On n'autorise le zoom QUE si l'image a la classe 'is-episode'
    if (!pImg || !pImg.classList.contains('is-episode') || e.target.closest('.btn-share')) return;

    if (e.target === pImg) {
        pImg.classList.toggle('zoomed');
        document.body.style.overflow = pImg.classList.contains('zoomed') ? 'hidden' : '';
    } else if (pImg.classList.contains('zoomed')) {
        pImg.classList.remove('zoomed');
        document.body.style.overflow = '';
    }
});
window.addEventListener('scroll', function() {
    const logo = document.querySelector('.logo-main');
    if (logo) {
        let scrollPos = window.scrollY;
        // Le logo s'efface progressivement sur les 150 premiers pixels de scroll
        let opacity = 1 - (scrollPos / 150);
        logo.style.opacity = Math.max(opacity, 0);
    }
});
document.getElementById('player-img').src = "https://baleinesousgravillon.com/wp-content/uploads/2022/02/cropped-Baleine_sous_gravillon-1-270x270.png"; 
</script>
    <div id="toast">Lien de la s√©rie copi√© !</div>
</body>
</html>
