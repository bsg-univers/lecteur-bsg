<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Baleine sous gravillon ‚Äì Player</title>

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0b0e14">

<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

:root{
--primary:#f3c300;

--black-void:#050608;
--blue-abyss:#031b28;
--green-abyss:#04251e;

--glass-soft:rgba(255,255,255,0.04);
--glass-strong:rgba(255,255,255,0.08);
}

body::before{
content:"";
position:fixed;
top:-1px;  /* D√©calage anti-aliasing */
left:-1px; /* D√©calage anti-aliasing */
right:0;
bottom:0;
pointer-events:none;
z-index:-1;
background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.035'/%3E%3C/svg%3E");
}


/* ===================== */
/*      FOND GLOBAL      */
/* ===================== */

html, body{
min-height:100%;
}

body{
font-family:'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
font-size:1.1rem;
color:#eaeaea;
margin:0;
padding-bottom:160px;

min-height:100vh;

background-color:#0b0e14;
background-image:
radial-gradient(circle at 20% 30%, rgba(70,130,180,0.28) 0%, transparent 60%),
radial-gradient(circle at 80% 70%, rgba(0,120,90,0.18) 0%, transparent 65%),
radial-gradient(circle at 50% 50%, rgba(0,40,60,0.22) 0%, transparent 70%);

background-repeat:no-repeat;
background-size:cover;
background-position:center center;
}

/* ===================== */
/*        HEADER         */
/* ===================== */
/* R√©initialisation globale */

header {
position: relative; /* Priorit√© d'affichage */
z-index: 10;        /* Priorit√© d'affichage */
width: 100%;
text-align: center;
padding: 32px 20px;
background: linear-gradient(to bottom, 
rgba(0,0,0,0.85) 0%, 
rgba(0,0,0,0.85) 5%, 
rgba(0,0,0,0.55) 90%);
box-shadow: 0 5px 90px rgba(0,0,0,0.8);
}

.logo-main{
max-width:200px;
margin-bottom:16px;
filter:
drop-shadow(0 0 14px rgba(243,195,0,0.25))
drop-shadow(0 0 40px rgba(243,195,0,0.08));
}

/* lien image */
.site-image-link{
display:inline-block;
width:82px;
height:82px;
border-radius:18px;
overflow:hidden;
background:#000;
box-shadow:
0 0 0 1px rgba(243,195,0,0.15),
0 15px 35px rgba(0,0,0,0.8);
transition:transform .35s ease, box-shadow .35s ease;
}

.site-image-link:hover{
transform:translateY(-4px) scale(1.06);
box-shadow:
0 0 0 1px rgba(243,195,0,0.35),
0 20px 45px rgba(0,0,0,0.9);
}

.site-image-link img{
width:100%;
height:100%;
object-fit:cover;
}

/* ===================== */
/*       CONTENU         */
/* ===================== */
.container{
max-width:820px;
margin:auto;
padding:28px 20px;
}

h2,h3{
color:var(--primary);
font-size:1.1rem;
letter-spacing:1px;
text-transform:uppercase;
margin:32px 0 18px;
padding-left:14px;
border-left:3px solid var(--primary);
text-shadow:0 0 10px rgba(243,195,0,0.15);
}

/* ===================== */
/*      SAISONS          */
/* ===================== */
.grid-list{
display:grid;
grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
gap:14px;
}

.season-item{
padding: 16px 12px; /* Plus grande zone de clic */
font-weight: 600;
font-size: 1.1rem;
border-radius:14px;
text-align:center;
cursor:pointer;

background:
linear-gradient(145deg,
rgba(255,255,255,0.06),
rgba(255,255,255,0.01));
border:1px solid rgba(255,255,255,0.08);

backdrop-filter:blur(10px);
box-shadow:
inset 0 0 0 1px rgba(0,0,0,0.4),
0 5px 15px rgba(0,0,0,0.6);

transition:all .3s ease;
}

.season-item:hover{
background:
linear-gradient(145deg,
rgba(243,195,0,0.9),
rgba(243,195,0,0.65));
color:#111;
transform:translateY(-4px);
box-shadow:
0 5px 15px rgba(0,0,0,0.8);
}

/* ===================== */
/*      √âPISODES         */
/* ===================== */
.episode-item{
margin-bottom:10px;
padding:16px 20px;
border-radius:16px;

display:flex;
align-items:center;
justify-content:space-between;

cursor:pointer;
border-left:0 solid var(--primary);
transition:all .25s ease;
}

.episode-item:hover{
background:
linear-gradient(160deg,
rgba(255,255,255,0.08),
rgba(255,255,255,0.02));
}

.episode-item.current{
border-left:6px solid var(--primary);

box-shadow:
0 5px 15px rgba(0,0,0,0.35);
}

.episode-title{
flex-grow:1;
margin-right:14px;
font-size:1.1rem;
}

/* bouton partage */
/* bouton partage */
.btn-share {
flex-shrink: 0; /* Empeche le cercle de s'√©craser */
background: transparent;
border: 1px solid rgba(243,195,0,0.6);
color: var(--primary);
width: 34px;
height: 34px;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
cursor: pointer;
transition: all .3s ease;
}

.btn-share:hover{
background:var(--primary);
color:#111;
}

/* ===================== */
/*        PLAYER         */
/* ===================== */
.player-container{
position:fixed;
bottom:0;
left:0;
right:0;

background:
linear-gradient(to top,
rgba(0,0,0,0.98),
rgba(6,8,10,0.94));
backdrop-filter:blur(18px);

padding:18px 30px 26px;
border-top:1px solid rgba(243,195,0,0.25);
box-shadow:0 -25px 60px rgba(0,0,0,0.95);
z-index:1000;
}

.now-playing{
text-align:center;
font-size:.85em;
font-weight:600;
color:var(--primary);
margin-bottom:14px;
text-shadow:0 0 12px rgba(243,195,0,0.2);
}

audio{
width:100%;
height:42px;
background-color: #383838;
}

/* ===================== */
/*       TOAST           */
/* ===================== */
#toast{
opacity:0;
pointer-events:none;

min-width:200px;
background:var(--primary);
color:#111;
text-align:center;
border-radius:30px;
padding:12px 18px;

position:fixed;
left:50%;
bottom:120px;
transform:translate(-50%, 12px);

font-weight:700;
font-size:.8em;

box-shadow:0 10px 30px rgba(0,0,0,0.8);

transition:
opacity .35s ease,
transform .35s ease;
}

#toast.show{
opacity:1;
transform:translate(-50%, 0);
}


.loader{
text-align:center;
color:var(--primary);
padding:24px;
font-style:italic;
}
</style>
</head>
<body>

<header>
<img src="https://baleinesousgravillon.com/wp-content/uploads/2023/08/logo-accueil3Plan-de-travail-2-copie-3@2x-1.png" alt="Logo" class="logo-main">
</header>

<div class="container">
<div id="seasons_grid" class="grid-list"></div>
<div id="episodes_list"></div>
</div>

<div class="player-container">
<div id="now-playing-title" class="now-playing">S√©lectionnez une aventure...</div>
<audio id="player" style="border-radius: 15px;" controls playsinline preload="auto"></audio>
</div>

<script>
// --- CONFIGURATION ---
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzm-Bo0UaQQ6JZJfotq7caGbTmCtpKY9Lgin2SWnrH5R3grgPPndNjCE8r4WbLg0LdP2w/exec"; // METS TON URL ICI
let episodes = [];
let current = 0;
let allPlaylists = [];

// --- LOGIQUE API ---
async function callApi(params) {
const url = `${SCRIPT_URL}?${params}`;
const response = await fetch(url);
return await response.json();
}

async function loadPlaylists() {
const urlParams = new URLSearchParams(window.location.search);
// On r√©cup√®re l'ID et on remplace les "+" par des espaces pour la comparaison
const initialPlaylistId = urlParams.get('playlistId') ? decodeURIComponent(urlParams.get('playlistId').replace(/\+/g, ' ')) : null;

allPlaylists = await callApi("action=getPlaylists");
allPlaylists = allPlaylists.filter(p => p.public);

const seasons = [...new Set(allPlaylists.map(p => p.season))].sort().reverse();
const div = document.getElementById('seasons_grid');
div.innerHTML = seasons.map(s => `<div class="season-item" onclick="showPlaylistsBySeason('${s}')">${s}</div>`).join('');

if (initialPlaylistId) {
// On cherche la playlist pour conna√Ætre sa saison
const sharedPlaylist = allPlaylists.find(p => String(p.id).trim() === initialPlaylistId.trim());
if (sharedPlaylist) {
// 1. On affiche d'abord la saison pour que l'interface soit coh√©rente
showPlaylistsBySeason(sharedPlaylist.season);
// 2. Puis on charge les √©pisodes (cela remplacera la liste de la saison)
loadEpisodes(sharedPlaylist.id);
} else {
showPlaylistsBySeason(seasons[0]);
}
} else {
showPlaylistsBySeason(seasons[0]);
}
}

function showPlaylistsBySeason(season) {
selectedSeason = season;
const filtered = allPlaylists.filter(p => p.season === season);
const div = document.getElementById('episodes_list');

div.innerHTML = `<h2>Playlists ‚Äî ${season}</h2>` + filtered.map(p => {
        // On remplace les apostrophes par leur code HTML pour √©viter de casser le onclick
        const safeId = String(p.id).replace(/'/g, "\\'"); 
        // Nettoyage de l'ID pour qu'il ne casse pas le HTML
        const safeId = String(p.id).replace(/'/g, "&apos;"); 

return `<div class="episode-item" onclick="loadEpisodes('${safeId}')">
           <span class="episode-title"><strong>${p.name}</strong></span>
           <button class="btn-share" onclick="sharePlaylist(event, '${safeId}')">üîó</button>
       </div>`;
}).join('');
}

function sharePlaylist(event, pid) {
event.stopPropagation();

    // On cr√©e l'URL propre de ton site GitHub
    const baseUrl = window.location.origin + window.location.pathname;
    const url = new URL(baseUrl);
    
    // set() g√®re automatiquement l'encodage des apostrophes, espaces et majuscules
    // On reconstruit l'URL sans accumuler les anciens param√®tres
    const url = new URL(window.location.origin + window.location.pathname);
url.searchParams.set('playlistId', pid);

    const finalUrl = url.toString();
    const textToCopy = url.toString();

    // Utilisation de l'API de presse-papier
    // M√©thode de copie moderne avec secours pour mobile
if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(finalUrl).then(() => {
            showToast();
        }).catch(err => {
            console.error("Erreur de copie :", err);
        });
        navigator.clipboard.writeText(textToCopy).then(showToast);
} else {
        // M√©thode de secours si navigator.clipboard n'est pas dispo
const textArea = document.createElement("textarea");
        textArea.value = finalUrl;
        textArea.value = textToCopy;
document.body.appendChild(textArea);
textArea.select();
        document.execCommand("copy");
        try {
            document.execCommand('copy');
            showToast();
        } catch (err) {
            console.error('Erreur de copie manuelle', err);
        }
document.body.removeChild(textArea);
        showToast();
}
}

function showToast() {
const toast = document.getElementById("toast");
toast.className = "show";
setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
}

async function loadEpisodes(pid) {
    // On d√©code l'ID au cas o√π il contiendrait des codes comme %20 ou %27
    const cleanId = decodeURIComponent(pid);
    
const listDiv = document.getElementById('episodes_list');
listDiv.innerHTML = '<div class="loader">Plong√©e...</div>';
    episodes = await callApi(`action=getEpisodes&playlistId=${pid}`);

    episodes = await callApi(`action=getEpisodes&playlistId=${encodeURIComponent(cleanId)}`);
    
    if (!episodes || episodes.length === 0) {
        listDiv.innerHTML = '<p>Aucun √©pisode trouv√©.</p>';
        return;
    }

listDiv.innerHTML = `<h3>√âpisodes</h3>` + episodes.map((e, i) => `
       <div class="episode-item list-item-ep" id="ep-${i}" onclick="play(${i})">
           <span class="episode-title">${e.title}</span>
       </div>`).join('');
play(0);
}

async function play(i) {
current = i;
const audio = document.getElementById('player');
const titleDisplay = document.getElementById('now-playing-title');

// Visuel
document.querySelectorAll('.list-item-ep').forEach(el => el.classList.remove('current'));
document.getElementById(`ep-${i}`)?.classList.add('current');
titleDisplay.innerText = "Chargement : " + episodes[i].title;

// R√©cup√©ration audio
const audioUrl = await callApi(`action=getAudio&guid=${episodes[i].guid}`);
if (audioUrl) {
audio.src = audioUrl;
audio.play();
updateMediaSession(episodes[i].title);
}
}

function updateMediaSession(title) {
if ('mediaSession' in navigator) {
navigator.mediaSession.metadata = new MediaMetadata({
title: title,
artist: "Baleine sous gravillon",
artwork: [{ src: 'https://image.ausha.co/CQMRa8hZ950ZAamQlgLxjsA38VuxGAXyvYCZXFXK_400x400.jpeg', sizes: '400x400', type: 'image/jpeg' }]
});

navigator.mediaSession.setActionHandler('nexttrack', () => { if(current+1 < episodes.length) play(current+1); });
navigator.mediaSession.setActionHandler('previoustrack', () => { if(current-1 >= 0) play(current-1); });
}
}

document.getElementById('player').onended = () => {
if (current + 1 < episodes.length) play(current + 1);
};

loadPlaylists();
</script>
<div id="toast">Lien copi√© !</div>
</body>
</html>
